<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music â€“ Physio SUAI V8</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/hybrid-config.js"></script>
  <style>
    body,html{height:100%;margin:0;}
    #player-frame{width:100%;border:none;flex:1;min-height:0;display:none}
    .svc-card{transition:all .2s;cursor:pointer;position:relative;overflow:hidden;}
    .svc-card:active{transform:scale(.95);}
    .svc-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.1),transparent);pointer-events:none;}

    /* â”€â”€ Empire Toast â”€â”€ */
    #empireToast{
      position:fixed;inset:0;z-index:99999;
      display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    #empireCard{
      background:linear-gradient(145deg,#0a0a1a 0%,#1a0533 45%,#0d1a2e 100%);
      border:1.5px solid rgba(167,139,250,.45);
      border-radius:28px;padding:28px 32px;text-align:center;
      width:88%;max-width:310px;
      box-shadow:0 0 80px rgba(167,139,250,.25),0 24px 60px rgba(0,0,0,.85);
      transform:scale(0) translateY(40px);opacity:0;
      transition:transform .55s cubic-bezier(.34,1.56,.64,1),opacity .4s ease;
      position:relative;overflow:hidden;
    }
    #empireCard.show{transform:scale(1) translateY(0);opacity:1;}
    #empireCard.hide{transform:scale(.78) translateY(-24px);opacity:0;transition:transform .38s ease,opacity .3s ease;}
    /* glowing ring */
    #empireCard::before{
      content:'';position:absolute;inset:-2px;
      background:linear-gradient(135deg,#ec4899,#8b5cf6,#a78bfa,#ec4899);
      background-size:300% 300%;
      animation:gradRing 3s linear infinite;
      border-radius:29px;z-index:-1;opacity:.6;
    }
    @keyframes gradRing{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    /* vinyl */
    #empireVinyl{
      width:76px;height:76px;border-radius:50%;margin:0 auto 14px;position:relative;
      background:radial-gradient(circle at 50%,#111 26%,#1a1a2e 27%,#0f3460 42%,#533483 56%,#ec4899 68%,#8b5cf6 78%,#1a1a2e 79%);
      animation:vinylSpin 2.2s linear infinite;
      box-shadow:0 0 24px rgba(236,72,153,.6),0 0 48px rgba(139,92,246,.3);
    }
    #empireVinyl::after{content:'';position:absolute;inset:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:#fff;border-radius:50%;box-shadow:0 0 6px rgba(255,255,255,.8);}
    @keyframes vinylSpin{to{transform:rotate(360deg)}}

    .empire-badge{font-size:10px;font-weight:800;color:#a78bfa;text-transform:uppercase;letter-spacing:2.5px;margin-bottom:8px;}
    .empire-title{font-size:17px;font-weight:800;color:#fff;line-height:1.35;margin-bottom:2px;}
    .empire-artist{font-size:13px;color:#9ca3af;margin-bottom:4px;}
    .empire-sub{font-size:12px;color:#6b7280;}
    /* progress bar */
    #empireBar{height:3px;border-radius:3px;background:linear-gradient(90deg,#ec4899,#8b5cf6,#a78bfa);margin-top:16px;width:0;transition:width 3s linear;}
    #empireBar.grow{width:100%;}

    /* floating notes */
    @keyframes noteFloat{0%{transform:translateY(0) rotate(-8deg) scale(1);opacity:1}100%{transform:translateY(-60px) rotate(12deg) scale(1.2);opacity:0}}
    .float-note{position:absolute;font-size:20px;animation:noteFloat 1.6s ease-out forwards;pointer-events:none;z-index:10;}
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col" style="height:100dvh">

  <!-- NAV -->
  <nav class="bg-gray-800 border-b border-gray-700 px-4 py-3 flex-shrink-0">
    <div class="max-w-4xl mx-auto flex items-center gap-3">
      <button onclick="goBack()" id="backBtn"
        class="w-10 h-10 rounded-xl bg-gray-700 flex items-center justify-center text-xl hover:bg-gray-600 flex-shrink-0">â†</button>
      <h1 id="pageTitle" class="font-bold flex-1 text-center">ğŸµ Music</h1>
      <button onclick="closePlayer()" id="closeBtn"
        class="hidden w-10 h-10 rounded-xl bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/40 flex-shrink-0">âœ•</button>
    </div>
  </nav>

  <!-- SERVICE PICKER -->
  <div id="picker" class="flex-1 overflow-y-auto p-5 flex flex-col items-center gap-5">

    <!-- â˜… FEATURED: Empire new release â˜… -->
    <div onclick="openEmpireSong()" class="w-full max-w-sm cursor-pointer active:scale-95 transition-transform">
      <div class="relative rounded-3xl p-5 text-center overflow-hidden"
           style="background:linear-gradient(135deg,#1a0533,#0f3460,#1a0533);border:2px solid rgba(167,139,250,.5);box-shadow:0 8px 32px rgba(139,92,246,.3)">
        <!-- animated glow -->
        <div style="position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(236,72,153,.1),transparent 70%);pointer-events:none;animation:pulse2 2s ease-in-out infinite"></div>
        <style>@keyframes pulse2{0%,100%{opacity:.6}50%{opacity:1}}</style>
        <div style="font-size:44px;margin-bottom:8px">ğŸµ</div>
        <div style="font-size:10px;font-weight:800;color:#a78bfa;text-transform:uppercase;letter-spacing:2px;margin-bottom:4px">ğŸŒŸ New Release by Empire</div>
        <div style="font-size:18px;font-weight:800;color:#fff;margin-bottom:2px">Akachukwu</div>
        <div style="font-size:12px;color:#9ca3af;margin-bottom:10px">Blissful Empire Â· Latest Drop</div>
        <span style="display:inline-block;background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-size:12px;font-weight:700;padding:5px 18px;border-radius:20px">â–¶ Play Now</span>
      </div>
    </div>

    <p class="text-gray-400 text-xs">â€” or stream from â€”</p>

    <div class="grid grid-cols-2 gap-4 w-full max-w-sm">

      <!-- Boomplay -->
      <button onclick="openService('boomplay')" class="svc-card bg-gradient-to-br from-red-600 to-red-900 rounded-3xl p-5 text-center shadow-xl shadow-red-900/40">
        <div class="text-5xl mb-3">ğŸµ</div>
        <p class="font-bold text-lg">Boomplay</p>
        <p class="text-xs text-red-200 mt-1">African Music</p>
        <span class="inline-block mt-2 px-2 py-0.5 bg-white/20 rounded-full text-xs">In-App âœ“</span>
      </button>

      <!-- Audiomack -->
      <button onclick="openService('audiomack')" class="svc-card bg-gradient-to-br from-orange-500 to-yellow-700 rounded-3xl p-5 text-center shadow-xl shadow-orange-900/40">
        <div class="text-5xl mb-3">ğŸ§</div>
        <p class="font-bold text-lg">Audiomack</p>
        <p class="text-xs text-orange-100 mt-1">Trending Hits</p>
        <span class="inline-block mt-2 px-2 py-0.5 bg-white/20 rounded-full text-xs">In-App âœ“</span>
      </button>

      <!-- YT Music -->
      <button onclick="openService('ytmusic')" class="svc-card bg-gradient-to-br from-rose-700 to-rose-900 rounded-3xl p-5 text-center shadow-xl shadow-rose-900/40">
        <div class="text-5xl mb-3">â–¶ï¸</div>
        <p class="font-bold text-lg">YT Music</p>
        <p class="text-xs text-rose-200 mt-1">YouTube Music</p>
        <span class="inline-block mt-2 px-2 py-0.5 bg-white/20 rounded-full text-xs">In-App âœ“</span>
      </button>

      <!-- SoundCloud -->
      <button onclick="openService('soundcloud')" class="svc-card bg-gradient-to-br from-orange-500 to-orange-700 rounded-3xl p-5 text-center shadow-xl shadow-orange-900/40">
        <div class="text-5xl mb-3">â˜ï¸</div>
        <p class="font-bold text-lg">SoundCloud</p>
        <p class="text-xs text-orange-100 mt-1">Independent Artists</p>
        <span class="inline-block mt-2 px-2 py-0.5 bg-white/20 rounded-full text-xs">In-App âœ“</span>
      </button>
    </div>

    <p class="text-xs text-gray-600 text-center max-w-xs">All services stream directly inside the app</p>
  </div>

  <!-- INLINE PLAYER -->
  <div id="playerView" class="hidden flex-1 flex flex-col" style="min-height:0">
    <div id="playerLoading" class="flex-1 flex flex-col items-center justify-center gap-4">
      <div class="w-14 h-14 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
      <p id="loadingLabel" class="text-gray-400">Loading musicâ€¦</p>
    </div>
    <iframe id="player-frame" class="border-none" style="flex:1;min-height:0;width:100%;display:none"
      allow="autoplay; encrypted-media; fullscreen; clipboard-write"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-top-navigation-by-user-activation"></iframe>
    <div id="playerError" class="hidden flex-1 flex flex-col items-center justify-center gap-4 p-8 text-center">
      <div id="errIcon" class="text-8xl"></div>
      <h2 id="errName" class="text-2xl font-bold"></h2>
      <p class="text-gray-400 text-sm max-w-xs">Tap below to retry or open in browser</p>
      <button onclick="retryProxy()" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3 px-8 rounded-2xl">ğŸ”„ Retry In-App</button>
      <button onclick="directOpen()" class="bg-gray-700 text-white font-semibold py-3 px-8 rounded-2xl">ğŸŒ Open in Browser</button>
      <button onclick="closePlayer()" class="text-gray-500 text-sm mt-1">â† Choose another</button>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loadingOverlay" class="hidden fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p class="loading-text text-white mt-3">Loadingâ€¦</p>
    </div>
  </div>

  <!-- EMPIRE TOAST (shown on page load) -->
  <div id="empireToast">
    <div id="empireCard">
      <div id="empireVinyl"></div>
      <div class="empire-badge">ğŸµ New Release</div>
      <div class="empire-title">Listen to the latest<br>song by Empire</div>
      <div class="empire-artist">Akachukwu â€“ Blissful Empire</div>
      <div class="empire-sub">Tap "Play Now" to stream</div>
      <div id="empireBar"></div>
    </div>
  </div>

  <script src="../js/main.js"></script>
  <script>
    var PROXY = 'https://corsproxy.io/?';
    var currentSvc = null;

    var SERVICES = {
      boomplay: {
        name:'Boomplay', icon:'ğŸµ',
        url:'https://www.boomplay.com/browse',
        embedUrl:null, useProxy:true
      },
      audiomack: {
        name:'Audiomack', icon:'ğŸ§',
        url:'https://audiomack.com/trending-songs',
        embedUrl:'https://audiomack.com/embed/trending-songs',
        useProxy:false
      },
      ytmusic: {
        name:'YT Music', icon:'â–¶ï¸',
        url:'https://music.youtube.com',
        embedUrl:null, useProxy:true
      },
      soundcloud: {
        name:'SoundCloud', icon:'â˜ï¸',
        url:'https://soundcloud.com/discover',
        embedUrl:'https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/discover&auto_play=false&hide_related=false&show_comments=false&show_user=true&show_reposts=false&visual=true',
        useProxy:false
      },
      empire: {
        name:'Empire â€“ Akachukwu', icon:'ğŸµ',
        url:'https://audiomack.com/blissful-empire/song/akachukwu',
        embedUrl:'https://audiomack.com/embed/blissful-empire/song/akachukwu',
        useProxy:false
      }
    };

    // â”€â”€ Empire featured song â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openEmpireSong() {
      openService('empire');
    }

    // â”€â”€ Open service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function goBack() { if (currentSvc) closePlayer(); else location.href = '../home.html'; }

    function openService(key) {
      var s = SERVICES[key];
      currentSvc = key;
      document.getElementById('picker').classList.add('hidden');
      document.getElementById('playerView').classList.remove('hidden');
      document.getElementById('playerLoading').classList.remove('hidden');
      document.getElementById('playerError').classList.add('hidden');
      document.getElementById('player-frame').style.display = 'none';
      document.getElementById('closeBtn').classList.remove('hidden');
      document.getElementById('pageTitle').textContent = s.icon + ' ' + s.name;
      document.getElementById('loadingLabel').textContent = 'Loading ' + s.name + 'â€¦';
      if (!s.useProxy && s.embedUrl) {
        tryNativeEmbed(s.embedUrl, s);
      } else {
        loadViaProxy(s.url, s);
      }
    }

    function tryNativeEmbed(embedUrl, s) {
      var frame = document.getElementById('player-frame');
      frame.src = embedUrl;
      frame.style.display = 'block';
      var timer = setTimeout(function() {
        try {
          var doc = frame.contentDocument || frame.contentWindow.document;
          if (!doc || !doc.body || doc.body.innerHTML === '') loadViaProxy(s.url, s);
          else document.getElementById('playerLoading').classList.add('hidden');
        } catch(e) {
          document.getElementById('playerLoading').classList.add('hidden');
        }
      }, 5000);
      frame.onload = function() { clearTimeout(timer); document.getElementById('playerLoading').classList.add('hidden'); frame.style.display = 'block'; };
    }

    function loadViaProxy(targetUrl, s) {
      document.getElementById('loadingLabel').textContent = 'Loading ' + s.name + ' in-appâ€¦';
      fetch(PROXY + encodeURIComponent(targetUrl), { signal: AbortSignal.timeout(20000) })
        .then(function(r) { if (!r.ok) throw new Error(r.status); return r.text(); })
        .then(function(html) {
          var base = targetUrl.match(/^(https?:\/\/[^/]+)/)[1];
          var patched = html
            .replace(/<head([^>]*)>/i, '<head$1><base href="' + base + '/">')
            .replace(/top\.location(\s*=|\s*\.href\s*=)/g, '//BLOCKED=')
            .replace(/parent\.location(\s*=|\s*\.href\s*=)/g, '//BLOCKED=')
            .replace(/window\.top\s*!==?\s*window(?:\.self)?/g, 'false')
            .replace(/if\s*\(\s*(?:top|window\.top)\s*!={1,2}\s*(?:self|window(?:\.self)?)\s*\)/g, 'if(false)');
          var frame = document.getElementById('player-frame');
          frame.srcdoc = patched; frame.style.display = 'block';
          document.getElementById('playerLoading').classList.add('hidden');
        })
        .catch(function(err) { console.error(err); showMusicError(s); });
    }

    function showMusicError(s) {
      document.getElementById('playerLoading').classList.add('hidden');
      document.getElementById('player-frame').style.display = 'none';
      document.getElementById('playerError').classList.remove('hidden');
      document.getElementById('errIcon').textContent = s.icon;
      document.getElementById('errName').textContent = s.name;
    }

    function retryProxy() {
      if (!currentSvc) return;
      var s = SERVICES[currentSvc];
      document.getElementById('playerError').classList.add('hidden');
      document.getElementById('playerLoading').classList.remove('hidden');
      loadViaProxy(s.url, s);
    }

    function directOpen() { if (currentSvc) window.open(SERVICES[currentSvc].url, '_blank'); }

    function closePlayer() {
      currentSvc = null;
      try { document.getElementById('player-frame').src = 'about:blank'; document.getElementById('player-frame').srcdoc = ''; } catch(e){}
      document.getElementById('player-frame').style.display = 'none';
      document.getElementById('playerView').classList.add('hidden');
      document.getElementById('playerError').classList.add('hidden');
      document.getElementById('picker').classList.remove('hidden');
      document.getElementById('closeBtn').classList.add('hidden');
      document.getElementById('pageTitle').textContent = 'ğŸµ Music';
    }

    // â”€â”€ Empire Toast Animation (on page load) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', function() {
      setTimeout(showEmpireToast, 500);
    });

    function showEmpireToast() {
      var card = document.getElementById('empireCard');
      var bar  = document.getElementById('empireBar');
      // Show
      card.classList.add('show');
      setTimeout(function() { bar.classList.add('grow'); }, 250);
      spawnNotes();
      // Hide after 3 seconds
      setTimeout(function() {
        card.classList.add('hide');
        setTimeout(function() {
          document.getElementById('empireToast').style.display = 'none';
        }, 400);
      }, 3200);
    }

    function spawnNotes() {
      var card  = document.getElementById('empireCard');
      var notes = ['ğŸµ','ğŸ¶','ğŸ¤','ğŸ¸','âœ¨','ğŸ”¥'];
      for (var i = 0; i < 6; i++) {
        (function(idx) {
          setTimeout(function() {
            var n = document.createElement('span');
            n.className = 'float-note';
            n.textContent = notes[idx % notes.length];
            n.style.left = (15 + Math.random() * 65) + '%';
            n.style.top  = (20 + Math.random() * 30) + '%';
            card.appendChild(n);
            setTimeout(function() { if (n.parentNode) n.remove(); }, 1700);
          }, idx * 260);
        })(i);
      }
    }

    // â”€â”€ Auth gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    auth.onAuthStateChanged(function(user) {
      if (!user) location.href = '../index.html';
    });
  </script>
</body>
</html>
