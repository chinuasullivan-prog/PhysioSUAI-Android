<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Books â€“ Physio SUAI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/hybrid-config.js"></script>
  <script src="../js/main.js"></script>
  <style>
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    .fade-up{animation:fadeUp .35s ease both}
    .book-card{transition:transform .2s,box-shadow .2s}
    .book-card:hover{transform:translateY(-3px);box-shadow:0 8px 32px rgba(0,0,0,.5)}
    .tab-btn{padding:8px 18px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:background .2s,color .2s;white-space:nowrap}
    .tab-btn.active{background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff}
    .tab-btn:not(.active){background:#1f2937;color:#9ca3af}
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<!-- NAV -->
<nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40 px-4 py-3">
  <div class="max-w-2xl mx-auto flex items-center gap-3">
    <button onclick="history.back()" style="width:42px;height:42px;border-radius:14px;background:#1f2937;border:1.5px solid #374151;color:#e5e7eb;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <h1 class="font-bold text-lg flex-1">ğŸ“š Book Market</h1>
    <button onclick="showSellModal()" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:10px 18px;border-radius:14px;border:none;cursor:pointer;font-size:14px">+ Sell Book</button>
  </div>
</nav>

<!-- SEARCH + FILTER -->
<div class="sticky top-14 z-30 bg-gray-900 border-b border-gray-800 px-4 py-3">
  <div class="max-w-2xl mx-auto space-y-3">
    <div style="display:flex;align-items:center;gap:8px;background:#1f2937;border-radius:20px;padding:10px 16px;border:1.5px solid #374151">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="searchInput" type="search" placeholder="Search by title or courseâ€¦" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:14px" oninput="renderBooks()">
    </div>
    <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:2px;scrollbar-width:none">
      <button class="tab-btn active" onclick="setFilter('all',this)">All</button>
      <button class="tab-btn" onclick="setFilter('Anatomy',this)">Anatomy</button>
      <button class="tab-btn" onclick="setFilter('Physiology',this)">Physiology</button>
      <button class="tab-btn" onclick="setFilter('Clinical',this)">Clinical</button>
      <button class="tab-btn" onclick="setFilter('Pathology',this)">Pathology</button>
      <button class="tab-btn" onclick="setFilter('Other',this)">Other</button>
    </div>
  </div>
</div>

<!-- BOOKS GRID -->
<div class="max-w-2xl mx-auto px-4 py-4">
  <div id="booksGrid" class="space-y-4">
    <div class="text-center py-12"><div class="w-10 h-10 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div>
  </div>
  <div id="emptyState" class="hidden text-center py-16">
    <div class="text-6xl mb-4">ğŸ“š</div>
    <p class="text-gray-400 text-lg font-semibold">No books listed yet</p>
    <p class="text-gray-600 text-sm mt-1">Be the first to sell a book!</p>
    <button onclick="showSellModal()" class="mt-6 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold px-8 py-3 rounded-2xl border-none cursor-pointer">+ Sell a Book</button>
  </div>
</div>

<!-- LOADING -->
<div id="loadingOverlay" class="hidden fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center">
  <div class="text-center"><div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mx-auto"></div><p class="loading-text text-white mt-3 font-medium">Loadingâ€¦</p></div>
</div>

<script>
var allBooks = [];
var activeFilter = 'all';
var pendingBookImage = null;
var pendingReceiptFile = null;
var selectedCondition = 'Good';

auth.onAuthStateChanged(function(user) {
  if (!user) { window.location.href = '../index.html'; return; }
  listenBooks();
});

function listenBooks() {
  db.ref('books').limitToLast(200).on('child_added', function(snap) {
    var b = Object.assign({ id: snap.key }, snap.val());
    if (!allBooks.find(function(x){ return x.id === b.id; })) allBooks.unshift(b);
    renderBooks();
  });
  db.ref('books').on('child_removed', function(snap) {
    allBooks = allBooks.filter(function(b){ return b.id !== snap.key; });
    renderBooks();
  });
  db.ref('books').on('child_changed', function(snap) {
    var idx = allBooks.findIndex(function(b){ return b.id === snap.key; });
    if (idx !== -1) allBooks[idx] = Object.assign({ id: snap.key }, snap.val());
    renderBooks();
  });
}

function renderBooks() {
  var q = ((document.getElementById('searchInput')||{}).value||'').toLowerCase();
  var filtered = allBooks.filter(function(b) {
    if (b.sold) return false;
    var matchFilter = activeFilter === 'all' || (b.course||'').toLowerCase().includes(activeFilter.toLowerCase());
    var matchSearch = !q || (b.name||'').toLowerCase().includes(q) || (b.course||'').toLowerCase().includes(q);
    return matchFilter && matchSearch;
  });
  var grid = document.getElementById('booksGrid');
  var empty = document.getElementById('emptyState');
  if (!grid) return;
  if (filtered.length === 0) { grid.innerHTML=''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  grid.innerHTML = filtered.map(function(b, i) {
    var condColor = b.condition==='New' ? 'background:#14532d;color:#86efac' : b.condition==='Good' ? 'background:#1e3a5f;color:#93c5fd' : 'background:#451a03;color:#fcd34d';
    var isMine = currentUser && b.sellerId === currentUser.uid;
    return '<div class="book-card fade-up bg-gray-800 rounded-2xl overflow-hidden border border-gray-700" style="animation-delay:' + Math.min(i*0.05,0.3) + 's">' +
      (b.imageUrl ? '<img src="' + b.imageUrl + '" alt="' + esc(b.name) + '" style="width:100%;height:200px;object-fit:cover;cursor:pointer" onclick="openImage(\'' + b.imageUrl + '\')">' :
        '<div style="height:120px;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;align-items:center;justify-content:center;font-size:56px">ğŸ“–</div>') +
      '<div style="padding:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px">' +
          '<h3 style="font-weight:800;font-size:17px;flex:1">' + esc(b.name) + '</h3>' +
          '<span style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;flex-shrink:0;' + condColor + '">' + (b.condition||'Good') + '</span>' +
        '</div>' +
        '<p style="color:#a78bfa;font-size:13px;margin-bottom:4px">ğŸ“š ' + esc(b.course||'General') + '</p>' +
        '<p style="color:#34d399;font-size:22px;font-weight:800;margin-bottom:10px">â‚¦' + Number(b.amount).toLocaleString() + '</p>' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">' +
          '<div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#ec4899,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px">' + (b.sellerName||'?')[0].toUpperCase() + '</div>' +
          '<span style="font-size:13px;color:#9ca3af">' + esc(b.sellerName||'Student') + '</span>' +
          '<span style="font-size:11px;color:#4b5563;margin-left:auto">' + tAgo(b.timestamp) + '</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">' +
          '<button onclick="openBookChat(\'' + b.id + '\',\'' + b.sellerId + '\',\'' + escQ(b.name) + '\',\'' + escQ(b.sellerName||'Seller') + '\')" style="background:#1e3a5f;color:#93c5fd;font-weight:700;padding:10px 4px;border-radius:12px;border:none;cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:2px"><span style="font-size:18px">ğŸ’¬</span>Chat</button>' +
          '<button onclick="whatsappBook(\'' + escQ(b.phone||'') + '\',\'' + escQ(b.name) + '\',\'' + b.amount + '\')" style="background:#14532d;color:#86efac;font-weight:700;padding:10px 4px;border-radius:12px;border:none;cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:2px"><span style="font-size:18px">ğŸ“²</span>WhatsApp</button>' +
          '<button onclick="showBuyModal(\'' + b.id + '\',\'' + escQ(b.name) + '\',\'' + b.amount + '\',\'' + escQ(b.phone||'') + '\',\'' + escQ(b.account||'') + '\',\'' + b.sellerId + '\')" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:10px 4px;border-radius:12px;border:none;cursor:pointer;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:2px"><span style="font-size:18px">ğŸ›’</span>Buy</button>' +
        '</div>' +
        (isMine ? '<button onclick="markSold(\'' + b.id + '\')" style="width:100%;margin-top:10px;background:#374151;color:#9ca3af;font-size:12px;font-weight:600;padding:8px;border-radius:10px;border:none;cursor:pointer">âœ… Mark as Sold</button>' : '') +
      '</div></div>';
  }).join('');
}

function setFilter(f, btn) {
  activeFilter = f;
  document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  renderBooks();
}

// â”€â”€ SELL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSellModal() {
  pendingBookImage = null; selectedCondition = 'Good';
  var m = mkModal('<div style="width:40px;height:4px;background:#374151;border-radius:2px;margin:0 auto 20px"></div>' +
    '<h2 style="font-size:20px;font-weight:800;margin-bottom:18px">ğŸ“š List Book for Sale</h2>' +
    '<div class="space-y-3">' +
      fld('text','sbn','Book Title *','e.g. Gray\'s Anatomy') +
      fld('text','sbc','Course / Subject *','e.g. Anatomy 201') +
      '<div><p style="font-size:12px;color:#9ca3af;font-weight:600;margin-bottom:8px">CONDITION *</p>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px" id="condBtns">' +
          cndBtn('New','#14532d','#86efac') + cndBtn('Good','#1e3a5f','#93c5fd') + cndBtn('Fair','#451a03','#fcd34d') +
        '</div></div>' +
      fld('number','sbp','Price (â‚¦) *','e.g. 3500') +
      fld('text','sba','Bank Account Number *','for receiving payment') +
      fld('tel','sbph','WhatsApp Number *','e.g. 08012345678') +
      '<button onclick="pickBookImg()" id="imgPickBtn" style="width:100%;background:#1f2937;border:1.5px dashed #374151;color:#9ca3af;padding:14px;border-radius:16px;cursor:pointer;font-size:14px;border-style:dashed">ğŸ“· Add Book Photo (optional)</button>' +
      '<div id="bookImgPrev" style="display:none;border-radius:12px;overflow:hidden;position:relative"><img id="bookImgThumb" style="width:100%;max-height:150px;object-fit:cover"><button onclick="clearBookImg()" style="position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,.7);color:#fff;border:none;cursor:pointer">âœ•</button></div>' +
    '</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px">' +
      '<button onclick="this.closest(\'.fixed\').remove()" style="background:#1f2937;color:#9ca3af;font-weight:600;padding:14px;border-radius:16px;border:1.5px solid #374151;cursor:pointer">Cancel</button>' +
      '<button onclick="doSellBook()" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:800;padding:14px;border-radius:16px;border:none;cursor:pointer">List for Sale â†’</button>' +
    '</div>');
  // Auto-select Good
  setTimeout(function(){ var b=document.querySelector('[data-cond="Good"]'); if(b) selectCond('Good',b); },50);
}

function fld(type,id,lbl,ph){
  return '<div><p style="font-size:12px;color:#9ca3af;font-weight:600;margin-bottom:6px">' + lbl + '</p><input type="' + type + '" id="' + id + '" placeholder="' + ph + '" style="width:100%;background:#1f2937;border:1.5px solid #374151;border-radius:14px;padding:12px 16px;color:#fff;font-size:14px;outline:none;box-sizing:border-box" onfocus="this.style.borderColor=\'#ec4899\'" onblur="this.style.borderColor=\'#374151\'"></div>';
}

function cndBtn(lbl,bg,fg){
  return '<button data-cond="' + lbl + '" onclick="selectCond(\'' + lbl + '\',this)" style="padding:10px;border-radius:12px;border:2px solid transparent;cursor:pointer;font-weight:700;font-size:13px;background:' + bg + ';color:' + fg + '">' + lbl + '</button>';
}

function selectCond(c, btn) {
  selectedCondition = c;
  document.querySelectorAll('[data-cond]').forEach(function(b){ b.style.borderColor='transparent'; });
  btn.style.borderColor='#ec4899';
}

function pickBookImg() {
  var inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
  inp.onchange=function(){
    if(!inp.files[0]) return;
    pendingBookImage=inp.files[0];
    var r=new FileReader(); r.onload=function(e){
      document.getElementById('bookImgThumb').src=e.target.result;
      document.getElementById('bookImgPrev').style.display='block';
      document.getElementById('imgPickBtn').style.display='none';
    }; r.readAsDataURL(inp.files[0]);
  }; inp.click();
}

function clearBookImg(){
  pendingBookImage=null;
  document.getElementById('bookImgPrev').style.display='none';
  document.getElementById('imgPickBtn').style.display='block';
}

async function doSellBook() {
  var name=(document.getElementById('sbn')||{}).value||'';
  var course=(document.getElementById('sbc')||{}).value||'';
  var price=(document.getElementById('sbp')||{}).value||'';
  var account=(document.getElementById('sba')||{}).value||'';
  var phone=(document.getElementById('sbph')||{}).value||'';
  if(!name.trim()||!course.trim()||!price||!account.trim()||!phone.trim()){showToast('Please fill all required fields','error');return;}
  if(!currentUser){showToast('Please log in first','error');return;}
  showLoading('Listing your bookâ€¦');
  var imageUrl=null;
  if(pendingBookImage){var up=await uploadFile(pendingBookImage,'books');if(up.success)imageUrl=up.url;}
  var sName=''; try{var s=await db.ref('users/'+currentUser.uid).once('value');var u=s.val();sName=(u&&u.name)?u.name:currentUser.email.split('@')[0];}catch(e){sName=currentUser.email.split('@')[0];}
  var res=await saveToFirebase('books',{name:name.trim(),course:course.trim(),amount:parseFloat(price),account:account.trim(),phone:phone.trim().replace(/\s/g,''),imageUrl:imageUrl,condition:selectedCondition,sellerId:currentUser.uid,sellerName:sName,timestamp:Date.now(),sold:false});
  hideLoading();
  if(res.success){closeModals();showToast('ğŸ“š Book listed! Classmates can see it now.');}
  else{showToast('Failed to list. Try again.','error');}
}

// â”€â”€ BUY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBuyModal(bookId, bName, amount, phone, account, sellerId) {
  pendingReceiptFile=null;
  mkModal('<div style="width:40px;height:4px;background:#374151;border-radius:2px;margin:0 auto 20px"></div>' +
    '<h2 style="font-size:20px;font-weight:800;margin-bottom:4px">ğŸ›’ Buy Book</h2>' +
    '<p style="color:#9ca3af;font-size:14px;margin-bottom:18px">' + esc(bName) + '</p>' +
    '<div style="background:#1f2937;border-radius:16px;padding:16px;margin-bottom:14px">' +
      iRow('ğŸ’° Price','â‚¦'+Number(amount).toLocaleString()) +
      iRow('ğŸ¦ Account',account||'Contact seller') +
      iRow('ğŸ“² WhatsApp',phone||'Not provided') +
    '</div>' +
    '<div style="background:#1e3a5f;border-radius:14px;padding:14px;margin-bottom:16px">' +
      '<p style="font-size:12px;color:#93c5fd;font-weight:700;margin-bottom:6px">ğŸ“‹ HOW TO BUY:</p>' +
      '<p style="font-size:13px;color:#bfdbfe;line-height:1.7">1ï¸âƒ£ Transfer â‚¦'+Number(amount).toLocaleString()+' to the account above<br>2ï¸âƒ£ Screenshot your receipt<br>3ï¸âƒ£ Upload it below â€” seller gets notified instantly</p>' +
    '</div>' +
    '<div id="rcptPrev" style="display:none;margin-bottom:12px;border-radius:12px;overflow:hidden;position:relative">' +
      '<img id="rcptThumb" style="width:100%;max-height:130px;object-fit:cover">' +
      '<div style="position:absolute;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center"><span style="background:#16a34a;color:#fff;font-weight:700;padding:6px 16px;border-radius:20px;font-size:13px">âœ“ Receipt ready</span></div>' +
    '</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">' +
      '<button onclick="pickReceipt()" id="rcptPickBtn" style="background:#1f2937;color:#e5e7eb;font-weight:700;padding:14px;border-radius:16px;border:1.5px dashed #374151;cursor:pointer;font-size:13px">ğŸ“ Upload Receipt</button>' +
      '<button onclick="doSendReceipt(\'' + bookId + '\',\'' + escQ(sellerId) + '\',\'' + escQ(bName) + '\')" style="background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;font-weight:800;padding:14px;border-radius:16px;border:none;cursor:pointer;font-size:13px">âœ… Notify Seller</button>' +
    '</div>' +
    '<button onclick="this.closest(\'.fixed\').remove()" style="width:100%;margin-top:10px;background:none;border:none;color:#6b7280;font-size:13px;cursor:pointer;padding:8px">Cancel</button>');
}

function iRow(l,v){return '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:#6b7280;font-size:13px">'+l+'</span><span style="font-weight:700;font-size:13px">'+v+'</span></div>';}

function pickReceipt(){
  var inp=document.createElement('input');inp.type='file';inp.accept='image/*,application/pdf';
  inp.onchange=function(){
    if(!inp.files[0])return;
    pendingReceiptFile=inp.files[0];
    var r=new FileReader();r.onload=function(e){
      if(inp.files[0].type.startsWith('image/')){document.getElementById('rcptThumb').src=e.target.result;document.getElementById('rcptPrev').style.display='block';}
      var pb=document.getElementById('rcptPickBtn');if(pb){pb.textContent='âœ“ Receipt selected';pb.style.borderColor='#16a34a';pb.style.color='#86efac';}
    };r.readAsDataURL(inp.files[0]);
  };inp.click();
}

async function doSendReceipt(bookId, sellerId, bName) {
  if(!pendingReceiptFile){showToast('Please upload your payment receipt first','error');return;}
  showLoading('Sending receipt to sellerâ€¦');
  var up=await uploadFile(pendingReceiptFile,'payments');
  if(!up.success){hideLoading();showToast('Upload failed. Try again.','error');return;}
  var bName2=''; try{var s=await db.ref('users/'+currentUser.uid).once('value');var u=s.val();bName2=(u&&u.name)?u.name:currentUser.email.split('@')[0];}catch(e){bName2=currentUser.email.split('@')[0];}
  await saveToFirebase('books/'+bookId+'/receipts',{buyerId:currentUser.uid,buyerName:bName2,proofUrl:up.url,timestamp:Date.now(),verified:false});
  sendNotification(sellerId,'ğŸ›’ '+bName2+' sent payment proof for "'+bName+'" â€” check your book receipts!');
  db.ref('notifications/'+sellerId).push({type:'book_purchase',message:bName2+' sent a receipt for "'+bName+'"',receiptUrl:up.url,buyerId:currentUser.uid,bookId:bookId,timestamp:Date.now(),read:false});
  pendingReceiptFile=null;hideLoading();closeModals();
  showToast('âœ… Receipt sent! Seller will contact you soon.');
}

// â”€â”€ IN-APP BOOK CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openBookChat(bookId, sellerId, bName, sellerName) {
  if(!currentUser){showToast('Login required','error');return;}
  if(sellerId===currentUser.uid){showToast("That's your own listing!",'error');return;}
  var chatId=[currentUser.uid,sellerId].sort().join('_')+'_bk';
  var chatModal=document.createElement('div');
  chatModal.className='fixed inset-0 z-50 flex flex-col';
  chatModal.style.background='#0f172a';
  chatModal.innerHTML=
    '<div style="background:#1f2937;border-bottom:1px solid #374151;padding:14px 16px;display:flex;align-items:center;gap:12px;flex-shrink:0">' +
      '<button onclick="this.closest(\'.fixed\').remove()" style="width:38px;height:38px;border-radius:12px;background:#374151;border:none;cursor:pointer;color:#fff;font-size:18px">â†</button>' +
      '<div style="flex:1"><p style="font-weight:800;font-size:15px">' + esc(sellerName) + '</p><p style="font-size:12px;color:#a78bfa">About: ' + esc(bName) + '</p></div>' +
    '</div>' +
    '<div id="bcMsgs" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px"></div>' +
    '<div style="padding:12px 16px;background:#1f2937;border-top:1px solid #374151;display:flex;gap:10px">' +
      '<div style="flex:1;display:flex;align-items:center;background:#111827;border:1.5px solid #374151;border-radius:24px;padding:0 6px 0 16px" id="bcWrap">' +
        '<input id="bcInp" placeholder="Message about this bookâ€¦" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:14px;padding:11px 4px" onkeydown="if(event.key===\'Enter\')sendBkChat(\'' + chatId + '\',\'' + escQ(bName) + '\',\'' + sellerId + '\')" onfocus="document.getElementById(\'bcWrap\').style.borderColor=\'#ec4899\'" onblur="document.getElementById(\'bcWrap\').style.borderColor=\'#374151\'">' +
        '<button onclick="sendBkChat(\'' + chatId + '\',\'' + escQ(bName) + '\',\'' + sellerId + '\')" style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(chatModal);
  db.ref('book_chats/'+chatId).limitToLast(80).on('child_added',function(snap){
    var m=snap.val(); var mine=m.senderId===currentUser.uid;
    var d=document.createElement('div');
    d.style.cssText='display:flex;'+(mine?'justify-content:flex-end':'justify-content:flex-start');
    d.innerHTML='<div style="max-width:78%;padding:10px 14px;font-size:14px;color:#fff;'+(mine?'background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:18px 18px 4px 18px':'background:#1f2937;border-radius:18px 18px 18px 4px')+'">' + esc(m.text) + '</div>';
    var msgs=document.getElementById('bcMsgs');
    if(msgs){msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;}
  });
}

async function sendBkChat(chatId, bName, sellerId) {
  var inp=document.getElementById('bcInp'); var text=(inp||{}).value||''; if(!text.trim())return;
  inp.value='';
  var sn=''; try{var s=await db.ref('users/'+currentUser.uid).once('value');var u=s.val();sn=(u&&u.name)?u.name:currentUser.email.split('@')[0];}catch(e){sn=currentUser.email.split('@')[0];}
  db.ref('book_chats/'+chatId).push({text:text,senderId:currentUser.uid,senderName:sn,timestamp:Date.now()});
  sendNotification(sellerId,'ğŸ’¬ '+sn+': "'+text.substring(0,40)+'" (re: "'+bName+'")');
}

function whatsappBook(phone, bName, amount) {
  if(!phone){showToast('Seller has no WhatsApp number listed','error');return;}
  var c=phone.replace(/[^0-9]/g,'');if(c.startsWith('0'))c='234'+c.slice(1);
  window.open('https://wa.me/'+c+'?text='+encodeURIComponent('Hi! I saw your book "'+bName+'" (â‚¦'+amount+') on Physio SUAI. Still available?'),'_blank');
}

async function markSold(bookId){
  if(!confirm('Mark this book as sold?'))return;
  await db.ref('books/'+bookId).update({sold:true});
  showToast('âœ… Marked as sold!');
}

function openImage(url){
  var o=document.createElement('div');o.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;cursor:pointer';o.onclick=function(){o.remove();};
  o.innerHTML='<img src="'+url+'" style="max-width:95vw;max-height:90vh;object-fit:contain;border-radius:12px">';
  document.body.appendChild(o);
}

function mkModal(inner){
  var m=document.createElement('div');m.className='fixed inset-0 z-50 bg-black/80 flex items-end';
  m.addEventListener('click',function(e){if(e.target===m)m.remove();});
  m.innerHTML='<div style="background:#111827;border-radius:24px 24px 0 0;padding:24px;width:100%;max-width:500px;margin:0 auto;max-height:92vh;overflow-y:auto">'+inner+'</div>';
  document.body.appendChild(m); return m;
}
function closeModals(){document.querySelectorAll('.fixed.inset-0').forEach(function(m){m.remove();});}
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escQ(s){return (s||'').replace(/'/g,"\\'").replace(/"/g,'').substring(0,60);}
function tAgo(ts){if(!ts)return '';var s=Math.floor((Date.now()-ts)/1000);if(s<60)return 'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
</script>
</body>
</html>
