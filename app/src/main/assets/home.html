<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Physio SUAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    
    
    
    <style>
        .nav-icon {
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .active-page {
            color: #ec4899;
            border-bottom: 2px solid #ec4899;
        }
    </style>
  <!-- Firebase FIRST -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <!-- Supabase SECOND -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- App -->
  <script src="js/hybrid-config.js"></script>
  <script src="js/main.js"></script>
  <script src="js/features.js"></script>
</head>
<body class="bg-gray-900 text-white">
    
    <!-- Top Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-40 bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">Physiotherapy</h1>
            </div>
            
            <button onclick="showProfile()" class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg hover:scale-110 transition">
                <span id="profileInitial">U</span>
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="pt-16 pb-20 min-h-screen" id="mainContent">
        <!-- Content loaded dynamically -->
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-40 bg-gray-800 border-t border-gray-700">
        <div class="max-w-7xl mx-auto px-2 py-2 flex items-center justify-around">
            <button onclick="loadPage('home')" id="nav-home" class="flex flex-col items-center space-y-1 px-4 py-2 hover:text-pink-500 transition active-page">
                <svg class="w-6 h-6 nav-icon" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span class="text-xs">Home</span>
            </button>
            
            <button onclick="loadPage('chats')" id="nav-chats" class="flex flex-col items-center space-y-1 px-4 py-2 hover:text-pink-500 transition">
                <svg class="w-6 h-6 nav-icon" viewBox="0 0 24 24">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span class="text-xs">Chats</span>
            </button>
            
            <button onclick="loadPage('school')" id="nav-school" class="flex flex-col items-center space-y-1 px-4 py-2 hover:text-pink-500 transition">
                <svg class="w-6 h-6 nav-icon" viewBox="0 0 24 24">
                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                    <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                </svg>
                <span class="text-xs">School</span>
            </button>
            
            <button onclick="loadPage('lectures')" id="nav-lectures" class="flex flex-col items-center space-y-1 px-4 py-2 hover:text-pink-500 transition">
                <svg class="w-6 h-6 nav-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span class="text-xs">Lectures</span>
            </button>
            
            <button onclick="loadPage('music')" id="nav-music" class="flex flex-col items-center space-y-1 px-4 py-2 hover:text-pink-500 transition">
                <svg class="w-6 h-6 nav-icon" viewBox="0 0 24 24">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
                <span class="text-xs">Music</span>
            </button>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="text-center space-y-4">
            <div class="w-16 h-16 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p class="loading-text text-white font-semibold">Loading...</p>
        </div>
    </div>
    <!-- Firebase for Auth + Database -->
    <script>
        // Check auth - use user.uid directly to avoid race with hybrid-config.js
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            // Pass uid directly - don't rely on global currentUser being set yet
            const profile = await getUserProfile(user.uid);
            if (profile && profile.name) {
                document.getElementById('profileInitial').textContent = profile.name[0].toUpperCase();
            }
        });

        // Page Management
        function loadPage(pageName) {
            // Update active nav
            document.querySelectorAll('[id^="nav-"]').forEach(btn => {
                btn.classList.remove('active-page');
            });
            document.getElementById(`nav-${pageName}`).classList.add('active-page');
            
            // Load page content
            const content = document.getElementById('mainContent');
            
            switch(pageName) {
                case 'home':
                    content.innerHTML = getHomeContent();
                    // Remove fixed chat input bar if present
                    var old = document.getElementById('chatInputBar');
                    if (old) old.remove();
                    break;
                case 'chats':
                    content.innerHTML = getChatsContent();
                    // Move chatInputBar to body (outside mainContent) for proper fixed positioning
                    var bar = document.getElementById('chatInputBar');
                    if (bar) document.body.appendChild(bar);
                    loadPublicChat(document.getElementById('chatMessages'));
                    break;
                case 'school':
                    content.innerHTML = getSchoolContent();
                    var old2 = document.getElementById('chatInputBar');
                    if (old2) old2.remove();
                    break;
                case 'lectures':
                    content.innerHTML = getLecturesContent();
                    var old3 = document.getElementById('chatInputBar');
                    if (old3) old3.remove();
                    loadLectures(document.getElementById('lecturesGrid'));
                    break;
                case 'music':
                    content.innerHTML = getMusicContent();
                    var old4 = document.getElementById('chatInputBar');
                    if (old4) old4.remove();
                    break;
            }
        }

        function getHomeContent() {
            return `
                <div class="max-w-7xl mx-auto p-4">
                    <h2 class="text-3xl font-bold mb-6">Welcome to Physio SUAI</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div onclick="loadSubpage('assignment')" class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-pink-500 transition cursor-pointer text-center">
                            <div class="text-5xl mb-3">üìù</div>
                            <h3 class="font-bold">Assignment</h3>
                        </div>
                        
                        <div onclick="loadSubpage('novel')" class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-purple-500 transition cursor-pointer text-center">
                            <div class="text-5xl mb-3">üìö</div>
                            <h3 class="font-bold">Novel</h3>
                        </div>
                        
                        <div onclick="loadSubpage('buybook')" class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-green-500 transition cursor-pointer text-center">
                            <div class="text-5xl mb-3">üìñ</div>
                            <h3 class="font-bold">Buy Book</h3>
                        </div>
                        
                        <div onclick="loadSubpage('funjokes')" class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-yellow-500 transition cursor-pointer text-center">
                            <div class="text-5xl mb-3">üòÇ</div>
                            <h3 class="font-bold">Fun Jokes</h3>
                        </div>
                        
                        <div onclick="loadSubpage('business')" class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-blue-500 transition cursor-pointer text-center">
                            <div class="text-5xl mb-3">üè™</div>
                            <h3 class="font-bold">Business</h3>
                        </div>
                        
                        <div onclick="loadSubpage('studyai')" class="bg-gray-800 rounded-2xl p-6 border-2 border-gray-700 hover:border-indigo-500 transition cursor-pointer text-center">
                            <div class="text-5xl mb-3">ü§ñ</div>
                            <h3 class="font-bold">Study AI</h3>
                        </div>
                    </div>
                </div>
            `;
        }

        function getChatsContent() {
            var emojis = ['üòÇ','ü§£','üò≠','üòç','ü•∞','üòé','ü§î','üòÖ','üî•','üíØ','üëç','‚ù§Ô∏è','üí™','üéâ','üò§','üôè','üò©','ü•∫','üòè','ü§Ø','üòá','ü§ë','üòú','ü§ó'];
            var emojiSpans = emojis.map(function(e){ return '<span onclick="insertEmoji(\'' + e + '\')" style="font-size:22px;cursor:pointer;text-align:center;padding:4px;border-radius:8px;display:block">' + e + '</span>'; }).join('');
            return '<div style="padding-bottom:130px">' +
                    '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #374151;background:#111827;position:sticky;top:0;z-index:10">' +
                        '<h2 style="font-size:20px;font-weight:800;margin:0">Public Chat</h2>' +
                        '<button onclick="window.location.href=\'pages/chat.html\'" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:8px 16px;border-radius:14px;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:14px">' +
                          '<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>' +
                          'Friends' +
                        '</button>' +
                    '</div>' +
                    '<div id="chatMessages" style="padding:12px 16px;min-height:200px"></div>' +
                   '</div>' +
                   '<div id="chatInputBar" style="position:fixed;bottom:56px;left:0;right:0;z-index:200;background:#0f172a;border-top:1px solid #374151;box-shadow:0 -4px 20px #000a">' +
                     '<div id="homeFileStrip" style="display:none;padding:8px 16px">' +
                       '<div style="display:flex;align-items:center;gap:10px;background:#374151;border-radius:12px;padding:8px 14px">' +
                         '<span style="font-size:18px">üìé</span>' +
                         '<span id="homeFileName" style="flex:1;font-size:13px;color:#d1d5db;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>' +
                         '<button onclick="clearChatFile()" style="color:#f87171;font-weight:700;font-size:18px;background:none;border:none;cursor:pointer;line-height:1">‚úï</button>' +
                       '</div>' +
                     '</div>' +
                     '<div id="homeEmojiPicker" style="display:none;padding:14px 16px">' +
                       '<div style="display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin-bottom:10px">' + emojiSpans + '</div>' +
                       '<button onclick="event.stopPropagation();closeHomeEmoji()" style="width:100%;color:#9ca3af;background:none;border:none;cursor:pointer;font-size:13px;padding:8px 0">Close ‚úï</button>' +
                     '</div>' +
                     '<div style="padding:10px 12px;display:flex;align-items:center;gap:10px">' +
                       '<button onclick="attachFile()" style="width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,#374151,#1f2937);border:1.5px solid #4b5563;color:#e5e7eb;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0" onmousedown="this.style.transform=\'scale(.92)\'" onmouseup="this.style.transform=\'\'">' +
                         '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>' +
                       '</button>' +
                       '<div style="flex:1;display:flex;align-items:center;background:#1f2937;border:1.5px solid #374151;border-radius:24px;padding:0 6px 0 10px;transition:border-color .2s;gap:4px" id="homeChatWrap">' +
                       '<button onclick="toggleHomeEmoji()" title="Emoji" style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#92400e,#78350f);border:1.5px solid #b45309;color:#fde68a;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer">' +
                         '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>' +
                       '</button>' +
                       '<input id="chatInput" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:15px;padding:11px 4px;font-family:inherit" placeholder="Type a message\u2026" onkeydown="if(event.key===\'Enter\')sendChatMessage()" oninput="onHomeChatType()" onfocus="document.getElementById(\'homeChatWrap\').style.borderColor=\'#ec4899\'" onblur="document.getElementById(\'homeChatWrap\').style.borderColor=\'#374151\'">' +
                       '<button id="homeSendBtn" onclick="sendChatMessage()" style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .2s;transform:scale(0);opacity:0;overflow:hidden">' +
                         '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>' +
                       '</button>' +
                     '</div>' +
                     '</div>' +
                   '</div>';
        }

        function onHomeChatType() {
            var val = (document.getElementById('chatInput') || {}).value || '';
            var btn = document.getElementById('homeSendBtn');
            if (!btn) return;
            if (val.trim().length > 0) {
                btn.style.transform = 'scale(1)'; btn.style.opacity = '1';
            } else {
                btn.style.transform = 'scale(0)'; btn.style.opacity = '0';
            }
        }

        function closeHomeEmoji() {
            var p = document.getElementById('homeEmojiPicker');
            if (p) p.style.display = 'none';
        }
        function toggleHomeEmoji(e) {
            if (e) e.stopPropagation();
            var p = document.getElementById('homeEmojiPicker');
            if (!p) return;
            p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none';
        }
        // Close emoji picker when tapping outside
        document.addEventListener('click', function(e) {
            var p = document.getElementById('homeEmojiPicker');
            if (!p || p.style.display === 'none') return;
            var isEmoji = e.target.closest('[onclick*="toggleHomeEmoji"]') || e.target.closest('[title="Emoji"]');
            if (!isEmoji && !p.contains(e.target)) closeHomeEmoji();
        });

        function clearChatFile() {
            currentChatFile = null;
            var s = document.getElementById('homeFileStrip');
            if (s) s.style.display = 'none';
        }

        function getSchoolContent() {
            return `
                <div class="max-w-2xl mx-auto p-4 flex flex-col gap-4">
                  <div class="text-center py-4">
                    <div style="font-size:72px;margin-bottom:12px">üéì</div>
                    <h2 class="text-2xl font-bold">ESUT Student Portal</h2>
                    <p style="color:#6b7280;font-size:13px;margin-top:4px">portal.esut.edu.ng</p>
                  </div>

                  <!-- In-App Loader (proxy) -->
                  <button onclick="loadSchoolInApp()"
                    style="width:100%;background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:18px 24px;border-radius:20px;border:none;cursor:pointer;display:flex;align-items:center;gap:16px;font-size:16px;box-shadow:0 6px 20px #ec489940">
                    <div style="width:48px;height:48px;background:rgba(255,255,255,.2);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üîì</div>
                    <div style="text-align:left">
                      <div style="font-weight:800;font-size:17px">Open Portal In-App</div>
                      <div style="font-size:12px;opacity:.8;font-weight:400">Loads here directly ‚Äì bypasses redirect</div>
                    </div>
                  </button>

                  <!-- Browser fallback -->
                  <button onclick="window.open('https://portal.esut.edu.ng/login.aspx','_blank')"
                    style="width:100%;background:#1f2937;color:#fff;font-weight:700;padding:16px 24px;border-radius:20px;border:1.5px solid #374151;cursor:pointer;display:flex;align-items:center;gap:16px;font-size:15px">
                    <div style="width:48px;height:48px;background:#374151;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üåê</div>
                    <div style="text-align:left">
                      <div style="font-weight:700">Open in Browser</div>
                      <div style="font-size:12px;color:#6b7280;font-weight:400">Standard browser experience</div>
                    </div>
                  </button>

                  <!-- Quick shortcuts -->
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                    <button onclick="loadSchoolInApp('student/results.aspx')"
                      style="background:#1e3a5f;color:#fff;font-weight:600;padding:14px 8px;border-radius:16px;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px">
                      <span style="font-size:24px">üìä</span>Results
                    </button>
                    <button onclick="loadSchoolInApp('student/coursereg.aspx')"
                      style="background:#14532d;color:#fff;font-weight:600;padding:14px 8px;border-radius:16px;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px">
                      <span style="font-size:24px">üìö</span>Courses
                    </button>
                    <button onclick="loadSchoolInApp('student/fees.aspx')"
                      style="background:#713f12;color:#fff;font-weight:600;padding:14px 8px;border-radius:16px;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px">
                      <span style="font-size:24px">üí≥</span>Fees
                    </button>
                  </div>

                  <div style="background:#1f2937;border-radius:16px;padding:16px;font-size:13px;color:#9ca3af;line-height:1.7">
                    <p style="color:#fff;font-weight:600;margin-bottom:8px">üí° Tips</p>
                    <p>‚Ä¢ <span style="color:#ec4899;font-weight:600">In-App</span> loads the portal directly here using a bypass proxy</p>
                    <p>‚Ä¢ If it shows blank, it means ESUT changed their security ‚Äì use <strong style="color:#fff">Open in Browser</strong></p>
                  </div>
                </div>
            `;
        }

        var SCHOOL_PROXY = 'https://corsproxy.io/?';
        var SCHOOL_BASE  = 'https://portal.esut.edu.ng/';

        function loadSchoolInApp(path) {
            var targetUrl = SCHOOL_BASE + (path || 'login.aspx');
            // Show portal inline viewer
            var content = document.getElementById('mainContent');
            content.innerHTML = `
              <div style="display:flex;flex-direction:column;height:calc(100vh - 8rem)">
                <div style="background:#1f2937;border-bottom:1px solid #374151;padding:10px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0">
                  <button onclick="loadPage('school')" style="width:38px;height:38px;background:#374151;border-radius:10px;border:none;cursor:pointer;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center">‚Üê</button>
                  <span style="flex:1;color:#9ca3af;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">portal.esut.edu.ng</span>
                  <button onclick="window.open('${targetUrl}','_blank')" style="background:#3b82f6;color:#fff;font-weight:600;padding:6px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px">‚Üó Browser</button>
                </div>
                <div id="schoolLoading" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:30px">
                  <div style="width:52px;height:52px;border:4px solid #ec4899;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>
                  <p style="color:#9ca3af;font-size:15px">Connecting to ESUT Portal‚Ä¶</p>
                  <p style="color:#4b5563;font-size:12px">Bypassing redirect security‚Ä¶</p>
                </div>
                <iframe id="schoolFrame" style="display:none;flex:1;width:100%;border:none;min-height:0"
                  sandbox="allow-scripts allow-same-origin allow-forms allow-top-navigation-by-user-activation"></iframe>
                <div id="schoolError" style="display:none;flex:1;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:30px">
                  <div style="font-size:56px">‚ö†Ô∏è</div>
                  <h3 style="font-weight:700;font-size:18px">Portal Blocked Embedding</h3>
                  <p style="color:#6b7280;font-size:14px;max-width:280px">ESUT's security blocked the in-app loader. Use browser mode instead.</p>
                  <button onclick="window.open('${targetUrl}','_blank')" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:12px 28px;border-radius:16px;border:none;cursor:pointer">Open in Browser üåê</button>
                  <button onclick="loadPage('school')" style="color:#6b7280;background:none;border:none;cursor:pointer;font-size:13px;margin-top:4px">‚Üê Back</button>
                </div>
              </div>
              <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
            `;
            // Fetch via proxy and inject
            fetch(SCHOOL_PROXY + encodeURIComponent(targetUrl), { signal: AbortSignal.timeout(15000) })
              .then(function(r){ if(!r.ok) throw new Error(r.status); return r.text(); })
              .then(function(html){
                var patched = html
                  .replace(/<head([^>]*)>/i, '<head$1><base href="' + SCHOOL_BASE + '">')
                  .replace(/top\.location(\s*=|\s*\.href\s*=)/g, '//BLOCKED=')
                  .replace(/parent\.location(\s*=|\s*\.href\s*=)/g, '//BLOCKED=')
                  .replace(/window\.top\s*!==?\s*window(?:\.self)?/g, 'false')
                  .replace(/if\s*\(\s*(?:top|window\.top)\s*!={1,2}\s*(?:self|window(?:\.self)?)\s*\)/g, 'if(false)')
                  .replace(/if\s*\(\s*window\s*!=\s*(?:top|window\.top)\s*\)/g, 'if(false)');
                var frame = document.getElementById('schoolFrame');
                if (!frame) return;
                frame.srcdoc = patched;
                frame.style.display = 'block';
                frame.style.flex = '1';
                document.getElementById('schoolLoading').style.display = 'none';
              })
              .catch(function(){
                var lo = document.getElementById('schoolLoading'), er = document.getElementById('schoolError');
                if (lo) lo.style.display = 'none';
                if (er) { er.style.display = 'flex'; }
              });
        }

        function getLecturesContent() {
            return `
                <div class="max-w-7xl mx-auto p-4">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold">Lecture Updates</h2>
                        <button onclick="showAddLectureModal()" class="bg-gradient-to-r from-pink-500 to-purple-600 px-6 py-3 rounded-xl hover:from-pink-600 hover:to-purple-700 transition font-semibold">
                            + Add Lecture
                        </button>
                    </div>
                    
                    <div id="lecturesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Lectures loaded here -->
                    </div>
                </div>
            `;
        }

        function getMusicContent() {
            // Show Empire animation toast after render
            setTimeout(showEmpireToast, 300);
            return `
                <div class="max-w-2xl mx-auto p-4 flex flex-col gap-4">

                  <!-- ‚òÖ EMPIRE FEATURED CARD ‚òÖ -->
                  <button onclick="openMusicInApp('empire')"
                    style="width:100%;background:linear-gradient(135deg,#1a0533,#0f1e3d,#1a0533);border:2px solid rgba(167,139,250,.5);border-radius:24px;padding:20px 16px;text-align:center;cursor:pointer;position:relative;overflow:hidden;box-shadow:0 8px 32px rgba(139,92,246,.35)"
                    onmousedown="this.style.transform='scale(.97)'" onmouseup="this.style.transform=''">
                    <div style="position:absolute;inset:0;background:radial-gradient(circle at 50%,rgba(236,72,153,.12),transparent 65%);pointer-events:none"></div>
                    <div style="font-size:10px;font-weight:800;color:#a78bfa;text-transform:uppercase;letter-spacing:2.5px;margin-bottom:6px">üåü New Release ¬∑ Empire</div>
                    <div style="font-size:36px;margin-bottom:8px">üéµ</div>
                    <div style="color:#fff;font-weight:800;font-size:20px;margin-bottom:3px">Akachukwu</div>
                    <div style="color:#9ca3af;font-size:13px;margin-bottom:12px">Blissful Empire ¬∑ Latest Drop</div>
                    <span style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-size:13px;font-weight:700;padding:8px 24px;border-radius:20px;display:inline-block">‚ñ∂ Play Now</span>
                  </button>

                  <p style="text-align:center;color:#6b7280;font-size:12px">‚Äî or stream from ‚Äî</p>

                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                    <!-- Boomplay -->
                    <button onclick="openMusicInApp('boomplay')"
                      style="background:linear-gradient(135deg,#dc2626,#7f1d1d);border-radius:24px;padding:22px 12px;text-align:center;border:none;cursor:pointer;transition:transform .15s;position:relative;overflow:hidden"
                      onmousedown="this.style.transform='scale(.95)'" onmouseup="this.style.transform=''">
                      <div style="font-size:48px;margin-bottom:10px">üéµ</div>
                      <div style="color:#fff;font-weight:800;font-size:17px">Boomplay</div>
                      <div style="color:#fca5a5;font-size:12px;margin-top:4px">African Music</div>
                      <div style="margin-top:8px;background:rgba(255,255,255,.2);border-radius:20px;padding:3px 10px;display:inline-block;color:#fff;font-size:11px;font-weight:600">In-App ‚úì</div>
                    </button>

                    <!-- Audiomack -->
                    <button onclick="openMusicInApp('audiomack')"
                      style="background:linear-gradient(135deg,#ea580c,#92400e);border-radius:24px;padding:22px 12px;text-align:center;border:none;cursor:pointer;transition:transform .15s"
                      onmousedown="this.style.transform='scale(.95)'" onmouseup="this.style.transform=''">
                      <div style="font-size:48px;margin-bottom:10px">üéß</div>
                      <div style="color:#fff;font-weight:800;font-size:17px">Audiomack</div>
                      <div style="color:#fed7aa;font-size:12px;margin-top:4px">Trending Hits</div>
                      <div style="margin-top:8px;background:rgba(255,255,255,.2);border-radius:20px;padding:3px 10px;display:inline-block;color:#fff;font-size:11px;font-weight:600">In-App ‚úì</div>
                    </button>

                    <!-- SoundCloud -->
                    <button onclick="openMusicInApp('soundcloud')"
                      style="background:linear-gradient(135deg,#ea580c,#c2410c);border-radius:24px;padding:22px 12px;text-align:center;border:none;cursor:pointer;transition:transform .15s"
                      onmousedown="this.style.transform='scale(.95)'" onmouseup="this.style.transform=''">
                      <div style="font-size:48px;margin-bottom:10px">‚òÅÔ∏è</div>
                      <div style="color:#fff;font-weight:800;font-size:17px">SoundCloud</div>
                      <div style="color:#fed7aa;font-size:12px;margin-top:4px">Independent Artists</div>
                      <div style="margin-top:8px;background:rgba(255,255,255,.2);border-radius:20px;padding:3px 10px;display:inline-block;color:#fff;font-size:11px;font-weight:600">In-App ‚úì</div>
                    </button>

                    <!-- YT Music -->
                    <button onclick="openMusicInApp('ytmusic')"
                      style="background:linear-gradient(135deg,#9f1239,#7f1d1d);border-radius:24px;padding:22px 12px;text-align:center;border:none;cursor:pointer;transition:transform .15s"
                      onmousedown="this.style.transform='scale(.95)'" onmouseup="this.style.transform=''">
                      <div style="font-size:48px;margin-bottom:10px">‚ñ∂Ô∏è</div>
                      <div style="color:#fff;font-weight:800;font-size:17px">YT Music</div>
                      <div style="color:#fca5a5;font-size:12px;margin-top:4px">YouTube Music</div>
                      <div style="margin-top:8px;background:rgba(255,255,255,.2);border-radius:20px;padding:3px 10px;display:inline-block;color:#fff;font-size:11px;font-weight:600">In-App ‚úì</div>
                    </button>
                  </div>
                </div>
            `;
        }

        // ‚îÄ‚îÄ EMPIRE TOAST ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showEmpireToast() {
            // Remove any existing toast
            var old = document.getElementById('empireToastEl');
            if (old) old.remove();

            var toast = document.createElement('div');
            toast.id = 'empireToastEl';
            toast.style.cssText = 'position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;pointer-events:none;';

            toast.innerHTML = `
              <div id="empireCardEl" style="
                background:linear-gradient(145deg,#0a0a1a 0%,#1a0533 45%,#0d1a2e 100%);
                border:1.5px solid rgba(167,139,250,.5);
                border-radius:28px;padding:28px 32px;text-align:center;
                width:88%;max-width:300px;
                box-shadow:0 0 70px rgba(167,139,250,.3),0 20px 60px rgba(0,0,0,.9);
                transform:scale(0) translateY(40px);opacity:0;
                transition:transform .5s cubic-bezier(.34,1.56,.64,1),opacity .4s ease;
                position:relative;overflow:hidden;
              ">
                <div id="empireVinylEl" style="
                  width:72px;height:72px;border-radius:50%;margin:0 auto 14px;
                  background:radial-gradient(circle at 50%,#111 26%,#1a1a2e 27%,#0f3460 42%,#533483 56%,#ec4899 68%,#8b5cf6 78%,#1a1a2e 79%);
                  animation:empireSpin 2s linear infinite;
                  box-shadow:0 0 22px rgba(236,72,153,.65);
                "></div>
                <div style="font-size:10px;font-weight:800;color:#a78bfa;text-transform:uppercase;letter-spacing:2.5px;margin-bottom:8px">üéµ New Release</div>
                <div style="font-size:18px;font-weight:800;color:#fff;line-height:1.35;margin-bottom:3px">Listen to the latest<br>song by Empire</div>
                <div style="font-size:13px;color:#9ca3af;margin-bottom:2px">Akachukwu ¬∑ Blissful Empire</div>
                <div id="empireBarEl" style="height:3px;border-radius:3px;background:linear-gradient(90deg,#ec4899,#8b5cf6,#a78bfa);margin-top:16px;width:0;transition:width 3s linear;"></div>
              </div>
              <style>
                @keyframes empireSpin{to{transform:rotate(360deg)}}
                @keyframes empireNote{0%{transform:translateY(0) rotate(-8deg);opacity:1}100%{transform:translateY(-55px) rotate(12deg);opacity:0}}
                .empire-note{position:absolute;font-size:20px;animation:empireNote 1.5s ease-out forwards;pointer-events:none;}
              </style>
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(function() {
                var card = document.getElementById('empireCardEl');
                var bar  = document.getElementById('empireBarEl');
                if (!card) return;
                card.style.transform = 'scale(1) translateY(0)';
                card.style.opacity   = '1';
                setTimeout(function() { if(bar) bar.style.width = '100%'; }, 300);

                // Float notes
                var notes = ['üéµ','üé∂','üé§','üé∏','‚ú®','üî•'];
                for (var i = 0; i < 6; i++) {
                    (function(idx) {
                        setTimeout(function() {
                            if (!card) return;
                            var n = document.createElement('span');
                            n.className = 'empire-note';
                            n.textContent = notes[idx % notes.length];
                            n.style.left = (15 + Math.random() * 65) + '%';
                            n.style.top  = '20px';
                            card.appendChild(n);
                            setTimeout(function() { if(n.parentNode) n.remove(); }, 1600);
                        }, idx * 260);
                    })(i);
                }

                // Hide after 3 seconds
                setTimeout(function() {
                    if (!card) return;
                    card.style.transition = 'transform .4s ease, opacity .35s ease';
                    card.style.transform  = 'scale(.75) translateY(-24px)';
                    card.style.opacity    = '0';
                    setTimeout(function() { if(toast.parentNode) toast.remove(); }, 400);
                }, 3200);
            }, 50);
        }

        var MUSIC_SERVICES = {
          empire:     { name:'Empire ‚Äì Akachukwu', icon:'üéµ',
                        url:'https://audiomack.com/blissful-empire/song/akachukwu',
                        embed:'https://audiomack.com/embed/blissful-empire/song/akachukwu' },
          boomplay:   { name:'Boomplay',   icon:'üéµ', url:'https://www.boomplay.com/browse' },
          audiomack:  { name:'Audiomack',  icon:'üéß', url:'https://audiomack.com/trending-songs',
                        embed:'https://audiomack.com/embed/trending-songs' },
          soundcloud: { name:'SoundCloud', icon:'‚òÅÔ∏è',
                        embed:'https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/discover&auto_play=false&visual=true' },
          ytmusic:    { name:'YT Music',   icon:'‚ñ∂Ô∏è', url:'https://music.youtube.com' }
        };

        function openMusicInApp(key) {
            var s = MUSIC_SERVICES[key];
            var content = document.getElementById('mainContent');
            content.innerHTML = `
              <div style="display:flex;flex-direction:column;height:calc(100vh - 8rem)">
                <div style="background:#1f2937;border-bottom:1px solid #374151;padding:10px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0">
                  <button onclick="loadPage('music')" style="width:38px;height:38px;background:#374151;border-radius:10px;border:none;cursor:pointer;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center">‚Üê</button>
                  <span style="flex:1;font-weight:700;font-size:15px">${s.icon} ${s.name}</span>
                  <button onclick="loadPage('music')" style="width:32px;height:32px;background:#ef4444;color:#fff;border-radius:8px;border:none;cursor:pointer;font-size:14px">‚úï</button>
                </div>
                <div id="musicLoading" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;text-align:center">
                  <div style="width:48px;height:48px;border:4px solid #ec4899;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>
                  <p style="color:#9ca3af">Loading ${s.name}‚Ä¶</p>
                </div>
                <iframe id="musicFrame" style="display:none;flex:1;width:100%;border:none;min-height:0"
                  allow="autoplay;encrypted-media;fullscreen"
                  sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-top-navigation-by-user-activation"></iframe>
                <div id="musicError" style="display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:30px;flex:1">
                  <div style="font-size:60px">${s.icon}</div>
                  <h3 style="font-weight:700;font-size:18px">${s.name}</h3>
                  <p style="color:#6b7280;font-size:14px;max-width:260px">This service blocked embedding. Retry or open in browser.</p>
                  <button onclick="retryMusicProxy('${key}')" style="background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;font-weight:700;padding:12px 24px;border-radius:14px;border:none;cursor:pointer">üîÑ Retry In-App</button>
                  <button onclick="window.open('${s.url || s.embed}','_blank')" style="background:#374151;color:#fff;font-weight:600;padding:10px 24px;border-radius:14px;border:none;cursor:pointer">üåê Open in Browser</button>
                </div>
              </div>
              <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
            `;

            if (s.embed) {
                // Has official embed - just use it directly
                var frame = document.getElementById('musicFrame');
                frame.src = s.embed;
                frame.style.display = 'block';
                frame.style.flex = '1';
                document.getElementById('musicLoading').style.display = 'none';
                frame.onerror = function() { showMusicError(key); };
            } else {
                // Load via proxy
                loadMusicProxy(key, s);
            }
        }

        function loadMusicProxy(key, s) {
            if (!s) s = MUSIC_SERVICES[key];
            fetch('https://corsproxy.io/?' + encodeURIComponent(s.url), { signal: AbortSignal.timeout(20000) })
              .then(function(r){ if(!r.ok) throw new Error(r.status); return r.text(); })
              .then(function(html){
                var base = s.url.match(/^(https?:\/\/[^/]+)/)[1];
                var patched = html
                  .replace(/<head([^>]*)>/i, '<head$1><base href="' + base + '/">')
                  .replace(/top\.location(\s*=|\s*\.href\s*=)/g, '//B=')
                  .replace(/window\.top\s*!==?\s*window(?:\.self)?/g, 'false')
                  .replace(/if\s*\(\s*(?:top|window\.top)\s*!={1,2}\s*(?:self|window(?:\.self)?)\s*\)/g, 'if(false)');
                var frame = document.getElementById('musicFrame');
                if (!frame) return;
                frame.srcdoc = patched;
                frame.style.display = 'block';
                frame.style.flex = '1';
                var lo = document.getElementById('musicLoading');
                if (lo) lo.style.display = 'none';
              })
              .catch(function(){ showMusicError(key); });
        }

        function retryMusicProxy(key) {
            var s = MUSIC_SERVICES[key];
            var er = document.getElementById('musicError'), lo = document.getElementById('musicLoading');
            if (er) er.style.display = 'none';
            if (lo) lo.style.display = 'flex';
            loadMusicProxy(key, s);
        }

        function showMusicError(key) {
            var lo = document.getElementById('musicLoading'), er = document.getElementById('musicError');
            if (lo) lo.style.display = 'none';
            if (er) er.style.display = 'flex';
        }

        // Subpage functions
        function loadSubpage(page) {
            window.location.href = `pages/${page}.html`;
        }

        let currentChatFile = null;

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message && !currentChatFile) return;
            
            let fileUrl = null, fileType = null;
            
            if (currentChatFile) {
                showLoading("Uploading file...");
                const upload = await uploadFile(currentChatFile, 'chat');
                if (upload.success) {
                    fileUrl = upload.url;
                    fileType = currentChatFile.type;
                }
                hideLoading();
                clearChatFile();
            }
            
            await sendMessage(message, fileUrl, fileType);
            input.value = '';
            onHomeChatType(); // hide send button
        }

        async function attachFile() {
            const inp = document.createElement('input');
            inp.type = 'file'; inp.accept = 'image/*,application/pdf';
            inp.onchange = function() {
                if (inp.files[0]) {
                    currentChatFile = inp.files[0];
                    var strip = document.getElementById('homeFileStrip');
                    var nameEl = document.getElementById('homeFileName');
                    if (strip && nameEl) {
                        nameEl.textContent = inp.files[0].name;
                        strip.style.display = 'block';
                    } else {
                        showToast('File selected: ' + inp.files[0].name);
                    }
                }
            };
            inp.click();
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value += emoji;
                onHomeChatType();
                input.focus();
            }
            // Close picker
            closeHomeEmoji();
        }

        function showFriendsList() {
            const modal = showModal('Friends', '<div id="friendsContainer" class="space-y-3"></div>', [
                { text: 'Close', onClick: 'this.closest(".fixed").remove()' }
            ]);
            
            loadFriends(document.getElementById('friendsContainer'));
        }

        // Lecture modal
        function showAddLectureModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
            modal.addEventListener('click', function(e) { if(e.target === modal) modal.remove(); });
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-2xl max-w-md w-full p-6 border border-gray-700">
                    <h3 class="text-2xl font-bold mb-6">Add Lecture</h3>
                    <form onsubmit="handleAddLecture(event)" class="space-y-4">
                        <input type="password" id="lecturePassword" placeholder="Password" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-pink-500" required>
                        <input type="text" id="lectureCourse" placeholder="Course Name" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-pink-500" required>
                        <input type="text" id="lectureLecturer" placeholder="Lecturer Name" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-pink-500" required>
                        <input type="text" id="lectureHall" placeholder="Lecture Hall" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-pink-500" required>
                        <input type="datetime-local" id="lectureTime" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-pink-500" required>
                        <div class="flex space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition">Cancel</button>
                            <button type="submit" class="flex-1 bg-pink-500 hover:bg-pink-600 px-4 py-3 rounded-lg transition">Submit</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function handleAddLecture(event) {
            event.preventDefault();
            
            const password = document.getElementById('lecturePassword').value;
            const course = document.getElementById('lectureCourse').value;
            const lecturer = document.getElementById('lectureLecturer').value;
            const hall = document.getElementById('lectureHall').value;
            const time = document.getElementById('lectureTime').value;
            
            const success = await submitLecture(course, lecturer, hall, time, password);
            
            if (success) {
                if (event && event.target && event.target.closest('.fixed')) event.target.closest('.fixed').remove(); else { var lm = document.querySelector('.fixed.inset-0.z-50'); if(lm) lm.remove(); }
                loadLectures(document.getElementById('lecturesGrid'));
            }
        }

        // Profile modal
        async function showProfile() {
            const profile = await getUserProfile();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
            modal.addEventListener('click', function(e) { if(e.target === modal) modal.remove(); });
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-2xl max-w-md w-full p-6 border border-gray-700">
                    <div class="text-center mb-6">
                        <div class="relative inline-block">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-white font-bold text-4xl mb-4 mx-auto">
                                ${(profile && profile.photoURL) ? '<img src="'+profile.photoURL+'" class="w-full h-full rounded-full object-cover">' : ((profile && profile.name) ? profile.name[0].toUpperCase() : 'U')}
                            </div>
                            <button onclick="changeProfilePhoto()" class="absolute bottom-0 right-0 bg-pink-500 w-8 h-8 rounded-full flex items-center justify-center hover:bg-pink-600 transition">
                                üì∑
                            </button>
                        </div>
                        <h3 class="text-2xl font-bold">${profile?.name || 'User'}</h3>
                        <p class="text-gray-400">${profile?.email || ''}</p>
                        <p class="text-sm text-gray-500 mt-2">${profile?.bio || 'Physio SUAI Member'}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="editProfile()" class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition">Edit Profile</button>
                        <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 px-4 py-3 rounded-lg transition">Logout</button>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function changeProfilePhoto() {
            const options = await showModal('Choose Photo Source', '', [
                { text: 'Cancel', onClick: 'this.closest(".fixed").remove()' },
                { text: 'üì∑ Camera', onClick: 'takePhoto()', class: 'bg-blue-500 hover:bg-blue-600' },
                { text: 'üñºÔ∏è Gallery', onClick: 'selectPhoto()', class: 'bg-green-500 hover:bg-green-600' }
            ]);
        }

        async function takePhoto() {
            var camModal = document.querySelector('.fixed.inset-0.z-50'); if(camModal) camModal.remove();
            const photo = await openCamera();
            if (photo) {
                await uploadProfilePhoto(photo);
            }
        }

        async function selectPhoto() {
            var selModal = document.querySelector('.fixed.inset-0.z-50'); if(selModal) selModal.remove();
            const file = await handleFileSelect('image/*');
            if (file) {
                await uploadProfilePhoto(file.file);
            }
        }

        async function uploadProfilePhoto(file) {
            showLoading("Uploading photo...");
            const compressed = await compressImage(file);
            const upload = await uploadFile(compressed, 'profiles');
            
            if (upload.success) {
                await updateUserProfile({ photoURL: upload.url });
                hideLoading();
                showToast('Profile photo updated!');
                showProfile();
            } else {
                hideLoading();
                showToast('Failed to upload photo', 'error');
            }
        }

        async function editProfile() {
            // Close existing modal first
            document.querySelectorAll('.fixed.inset-0.z-50').forEach(function(m){ m.remove(); });
            var profile = await getUserProfile();
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
            modal.addEventListener('click', function(e){ if(e.target===modal) modal.remove(); });
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-2xl max-w-md w-full p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-5">‚úèÔ∏è Edit Profile</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 font-semibold uppercase mb-1 block">Display Name</label>
                            <input id="epName" value="${(profile&&profile.name)||''}" placeholder="Your name"
                              class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-pink-500">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 font-semibold uppercase mb-1 block">Bio</label>
                            <input id="epBio" value="${(profile&&profile.bio)||''}" placeholder="Short bio"
                              class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-pink-500">
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl transition text-white">Cancel</button>
                            <button onclick="saveProfile()" class="flex-1 bg-gradient-to-r from-pink-500 to-purple-600 hover:opacity-90 py-3 rounded-xl font-bold text-white transition">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveProfile() {
            var name = (document.getElementById('epName')||{}).value || '';
            var bio  = (document.getElementById('epBio')||{}).value  || '';
            if (!name.trim()) { showToast('Name cannot be empty', 'error'); return; }
            showLoading('Saving‚Ä¶');
            await updateUserProfile({ name: name.trim(), bio: bio.trim() });
            hideLoading();
            document.querySelectorAll('.fixed.inset-0.z-50').forEach(function(m){ m.remove(); });
            document.getElementById('profileInitial').textContent = name.trim()[0].toUpperCase();
            showToast('‚úÖ Profile updated!');
        }

        async function logout() {
            await auth.signOut();
            window.location.href = 'index.html';
        }

        // Initialize
        loadPage('home');
    </script>
</body>
</html>
