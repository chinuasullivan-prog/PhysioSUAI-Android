<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat â€“ Physio SUAI V8</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/hybrid-config.js"></script>
  <style>
    .icon-btn { width:46px; height:46px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; transition:transform .15s; cursor:pointer; border:none; outline:none; }
    .icon-btn:active { transform:scale(.92); }
    .btn-attach { background:linear-gradient(135deg,#374151,#1f2937); border:1.5px solid #4b5563; color:#e5e7eb; }
    .btn-emoji  { background:linear-gradient(135deg,#92400e,#78350f); border:1.5px solid #b45309; color:#fde68a; }
    .btn-send   { background:linear-gradient(135deg,#ec4899,#8b5cf6); color:#fff; box-shadow:0 4px 16px rgba(236,72,153,.5); }
    /* Send btn animated appear */
    #sendBtn { transition: transform .3s cubic-bezier(.34,1.56,.64,1), opacity .2s, width .25s, padding .25s, margin .25s; }
    #sendBtn.hide { opacity:0; width:0 !important; min-width:0 !important; padding:0 !important; margin:0 !important; transform:scale(0.2) !important; pointer-events:none; overflow:hidden; }
    .msg-input { flex:1; padding:11px 16px; background:#1f2937; border:1.5px solid #374151; border-radius:24px; color:#fff; font-size:15px; outline:none; transition:border-color .2s; }
    .msg-input:focus { border-color:#ec4899; }
    .msg-input::placeholder { color:#6b7280; }
    /* Context menu */
    @keyframes ctxPop { from{opacity:0;transform:scale(.82) translateY(6px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .ctx-menu { animation:ctxPop .18s ease; position:fixed; z-index:9998; background:#1f2937; border:1.5px solid #374151; border-radius:18px; padding:8px; min-width:210px; box-shadow:0 10px 40px rgba(0,0,0,.8); }
    .ctx-item { display:flex; align-items:center; gap:10px; width:100%; padding:10px 14px; background:none; border:none; cursor:pointer; border-radius:12px; color:#e5e7eb; font-size:14px; font-weight:500; text-align:left; transition:background .15s; }
    .ctx-item:hover { background:#374151; }
    .ctx-danger { color:#f87171; }
    .ctx-emoji-row { display:flex; gap:5px; padding:8px 10px 10px; border-bottom:1px solid #374151; }
    .ctx-emoji-btn { font-size:23px; background:none; border:none; cursor:pointer; border-radius:8px; padding:3px 5px; transition:transform .1s; }
    .ctx-emoji-btn:hover { transform:scale(1.25); background:#374151; }
    /* Pinned banner */
    #pinnedBanner { display:none; align-items:center; gap:10px; padding:9px 16px; background:linear-gradient(135deg,#1e1b4b,#2d1f4e); border-bottom:2px solid #4c1d95; cursor:pointer; position:sticky; top:0; z-index:30; }
    #pinnedBanner .bar { width:3px; height:34px; background:linear-gradient(180deg,#a78bfa,#ec4899); border-radius:3px; flex-shrink:0; }
    @keyframes slideDown { from{opacity:0;transform:translateY(-100%)} to{opacity:1;transform:translateY(0)} }
    .slide-down { animation:slideDown .25s ease; }
    /* Dust delete */
    @keyframes bubbleFade { to{opacity:0;transform:scale(.75) translateY(-8px)} }
    .deleting { animation:bubbleFade .22s ease forwards; pointer-events:none; }
    /* Emoji grid */
    .emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:5px; }
    .emoji-grid span { font-size:22px; cursor:pointer; text-align:center; padding:4px; border-radius:8px; transition:background .1s; }
    .emoji-grid span:hover { background:#374151; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- NAV -->
  <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40 px-4 py-3">
    <div class="max-w-2xl mx-auto flex items-center gap-3">
      <button onclick="location.href='chat.html'" class="icon-btn btn-attach">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      </button>
      <button onclick="showProfile()" class="flex items-center gap-3 flex-1 min-w-0 hover:bg-gray-700/50 rounded-xl px-2 py-1 transition">
        <div id="friendAvatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center font-bold text-lg flex-shrink-0">?</div>
        <div class="flex-1 min-w-0 text-left">
          <p id="friendName" class="font-bold leading-tight truncate">Loadingâ€¦</p>
          <p class="text-xs text-green-400">ğŸ”’ End-to-end encrypted</p>
        </div>
      </button>
      <button onclick="confirmDeleteAll()" class="icon-btn btn-attach" title="Delete my messages">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
      </button>
    </div>
  </nav>

  <!-- PINNED BANNER -->
  <div id="pinnedBanner">
    <div class="bar"></div>
    <div style="flex:1;min-width:0" onclick="scrollToPinned()">
      <p style="font-size:11px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:.5px">ğŸ“Œ Pinned Message</p>
      <p id="pinnedText" style="font-size:13px;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></p>
    </div>
    <button onclick="unpinMsg(event)" style="background:none;border:none;color:#6b7280;font-size:20px;cursor:pointer;padding:4px;flex-shrink:0">âœ•</button>
  </div>

  <!-- MESSAGES -->
  <div id="msgs" class="flex-1 overflow-y-auto px-4 py-3 space-y-2 pb-24"></div>

  <!-- FILE STRIP -->
  <div id="fileStrip" class="hidden px-4 py-2 bg-gray-800 border-t border-gray-700">
    <div class="flex items-center gap-3 bg-gray-700 rounded-xl px-4 py-2 max-w-2xl mx-auto">
      <span class="text-xl">ğŸ“</span>
      <span id="fileStripName" class="flex-1 text-sm text-gray-300 truncate"></span>
      <button onclick="clearFile()" class="text-red-400 font-bold text-lg">âœ•</button>
    </div>
  </div>

  <!-- INPUT BAR -->
  <div class="px-4 py-3 bg-gray-800 border-t border-gray-700 sticky bottom-0 z-20">
    <div class="max-w-2xl mx-auto flex items-center gap-3">
      <button onclick="pickFile()" class="icon-btn btn-attach" title="Attach">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
      </button>
      <div style="flex:1;display:flex;align-items:center;background:#1f2937;border:1.5px solid #374151;border-radius:24px;padding:0 6px 0 10px;transition:border-color .2s;gap:4px" id="chatInputWrap">
        <button onclick="toggleEmoji()" title="Emoji" style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#92400e,#78350f);border:1.5px solid #b45309;color:#fde68a;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
        </button>
        <input id="inp" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:15px;padding:11px 4px;font-family:inherit" placeholder="Messageâ€¦"
          oninput="onInputChange()"
          onkeydown="if(event.key==='Enter')sendMsg()"
          onfocus="document.getElementById('chatInputWrap').style.borderColor='#ec4899'"
          onblur="document.getElementById('chatInputWrap').style.borderColor='#374151'">
        <button id="sendBtn" onclick="sendMsg()" title="Send"
          style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .2s;transform:scale(0);opacity:0;overflow:hidden">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- EMOJI PICKER -->
  <div id="emojiPicker" class="hidden fixed bottom-20 left-4 right-4 max-w-sm mx-auto z-50 bg-gray-800 border border-gray-600 rounded-2xl p-4 shadow-2xl">
    <div class="emoji-grid">
      <span onclick="ins('ğŸ˜‚')">ğŸ˜‚</span><span onclick="ins('ğŸ¤£')">ğŸ¤£</span><span onclick="ins('ğŸ˜­')">ğŸ˜­</span><span onclick="ins('ğŸ˜')">ğŸ˜</span>
      <span onclick="ins('ğŸ¥°')">ğŸ¥°</span><span onclick="ins('ğŸ˜')">ğŸ˜</span><span onclick="ins('ğŸ¤”')">ğŸ¤”</span><span onclick="ins('ğŸ˜…')">ğŸ˜…</span>
      <span onclick="ins('ğŸ”¥')">ğŸ”¥</span><span onclick="ins('ğŸ’¯')">ğŸ’¯</span><span onclick="ins('ğŸ‘')">ğŸ‘</span><span onclick="ins('â¤ï¸')">â¤ï¸</span>
      <span onclick="ins('ğŸ’ª')">ğŸ’ª</span><span onclick="ins('ğŸ‰')">ğŸ‰</span><span onclick="ins('ğŸ˜¤')">ğŸ˜¤</span><span onclick="ins('ğŸ™')">ğŸ™</span>
      <span onclick="ins('ğŸ˜©')">ğŸ˜©</span><span onclick="ins('ğŸ¥º')">ğŸ¥º</span><span onclick="ins('ğŸ˜')">ğŸ˜</span><span onclick="ins('ğŸ¤¯')">ğŸ¤¯</span>
      <span onclick="ins('ğŸ˜‡')">ğŸ˜‡</span><span onclick="ins('ğŸ¤‘')">ğŸ¤‘</span><span onclick="ins('ğŸ˜œ')">ğŸ˜œ</span><span onclick="ins('ğŸ¤—')">ğŸ¤—</span>
    </div>
    <button onclick="event.stopPropagation();closeEmoji()" class="mt-3 w-full text-sm text-gray-400 hover:text-white py-2 rounded-xl hover:bg-gray-700 transition">Close âœ•</button>
  </div>

  <!-- PROFILE MODAL -->
  <div id="profileModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-end" onclick="if(event.target===this)closeProfile()">
    <div class="bg-gray-800 w-full max-w-lg mx-auto rounded-t-3xl p-6 space-y-4">
      <div class="w-10 h-1 bg-gray-600 rounded mx-auto"></div>
      <div class="flex justify-center"><div id="pmAvatar" class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-white font-bold text-4xl"></div></div>
      <div class="text-center"><h2 id="pmName" class="text-2xl font-bold"></h2><p id="pmBio" class="text-gray-400 text-sm mt-1"></p><p id="pmEmail" class="text-gray-500 text-xs mt-1"></p></div>
      <p class="text-center text-green-400 text-sm">ğŸ”’ End-to-end encrypted</p>
      <button onclick="closeProfile()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-2xl transition">Close</button>
    </div>
  </div>

  <!-- DELETE ALL CONFIRM -->
  <div id="deleteAllModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-6" onclick="if(event.target===this)closeDeleteAll()">
    <div class="bg-gray-800 w-full max-w-sm rounded-3xl p-6 text-center space-y-4">
      <div class="text-5xl">ğŸ—‘ï¸</div>
      <h3 class="font-bold text-xl">Delete All Your Messages?</h3>
      <p class="text-gray-400 text-sm">Permanently removes every message you sent here.</p>
      <div class="flex gap-3">
        <button onclick="closeDeleteAll()" class="flex-1 bg-gray-700 text-white font-semibold py-3 rounded-2xl">Cancel</button>
        <button onclick="deleteAllMine()" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-2xl">Delete All</button>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loadingOverlay" class="hidden fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p class="loading-text text-white mt-3 font-medium">Loadingâ€¦</p>
    </div>
  </div>

  <script src="../js/main.js"></script>
  <script>
    var params     = new URLSearchParams(location.search);
    var friendUid   = params.get('uid');
    var friendName  = decodeURIComponent(params.get('name') || 'Friend');
    var chatId      = '';
    var pendingFile = null;
    var friendData  = {};
    var pinnedMsgId = null;
    var _lpt = null, _ctx = null, _ctxJustShown = false;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEND BUTTON: show when typing, hide when empty
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function onInputChange() {
      var val = document.getElementById('inp').value;
      var btn = document.getElementById('sendBtn');
      if (!btn) return;
      if (val.trim().length > 0 || pendingFile) {
        btn.style.transform = 'scale(1)';
        btn.style.opacity   = '1';
      } else {
        btn.style.transform = 'scale(0)';
        btn.style.opacity   = '0';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function init() {
      chatId = [currentUser.uid, friendUid].sort().join('_');
      document.getElementById('friendName').textContent = friendName;
      document.getElementById('friendAvatar').textContent = friendName[0].toUpperCase();

      // Load friend data
      db.ref('users/' + friendUid).once('value').then(function(s) {
        var u = s.val();
        if (u) {
          friendData = u;
          document.getElementById('friendName').textContent = u.name || friendName;
          document.getElementById('friendAvatar').textContent = (u.name || friendName)[0].toUpperCase();
        }
      });

      // Load pinned message
      db.ref('chat_pins/' + chatId).once('value').then(function(s) {
        var p = s.val();
        if (p) showPinnedBanner(p.msgId, p.text);
      });

      // Listen for new messages
      db.ref('chats/' + chatId).limitToLast(100).on('child_added', function(snap) {
        renderMsg({ id: snap.key, ...snap.val() });
      });

      // Listen for deletions (smooth fade-out)
      db.ref('chats/' + chatId).on('child_removed', function(snap) {
        var el = document.getElementById('cm_' + snap.key);
        if (el) {
          el.classList.add('deleting');
          setTimeout(function() { if (el.parentNode) el.remove(); }, 220);
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER MESSAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderMsg(m) {
      if (document.getElementById('cm_' + m.id)) return;
      var mine = m.senderUid === currentUser.uid;
      var c = document.getElementById('msgs');
      var wrap = document.createElement('div');
      wrap.id = 'cm_' + m.id;
      wrap.className = 'flex ' + (mine ? 'justify-end' : 'justify-start');

      var bubbleCls = mine
        ? 'bg-gradient-to-br from-pink-500 to-purple-600 rounded-br-sm text-white'
        : 'bg-gray-700 rounded-bl-sm';

      var fileHtml = '';
      if (m.fileUrl) {
        if (m.fileType && m.fileType.startsWith('image/')) {
          fileHtml = '<img src="' + m.fileUrl + '" class="rounded-xl mt-2 max-w-full max-h-48 object-cover cursor-pointer" onclick="window.open(\'' + m.fileUrl + '\')">';
        } else {
          fileHtml = '<a href="' + m.fileUrl + '" target="_blank" class="flex items-center gap-2 mt-2 text-blue-300 underline text-xs">ğŸ“ Open file</a>';
        }
      }

      var pinIcon = (pinnedMsgId === m.id) ? '<span style="font-size:10px;margin-left:4px;vertical-align:middle">ğŸ“Œ</span>' : '';

      wrap.innerHTML =
        '<div class="max-w-[76%] flex flex-col ' + (mine ? 'items-end' : 'items-start') + '">' +
          '<div class="' + bubbleCls + ' rounded-2xl px-4 py-3 text-sm break-words">' +
            (m.text ? m.text : '') + pinIcon + fileHtml +
          '</div>' +
          '<p class="text-[11px] text-gray-500 mt-0.5">' + timeAgo(m.ts) + '</p>' +
        '</div>';

      // Long-press to open context menu
      var bubble = wrap.querySelector('div > div');
      addLongPress(bubble, function(e) { showCtx(e, m.id, mine, m.text || ''); });

      c.appendChild(wrap);
      c.scrollTop = c.scrollHeight;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DUST DELETE ANIMATION (Telegram-style particles)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function dustDelete(el, callback) {
      var rect = el.getBoundingClientRect();
      var cv = document.createElement('canvas');
      cv.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999';
      cv.width = window.innerWidth; cv.height = window.innerHeight;
      document.body.appendChild(cv);
      var ctx = cv.getContext('2d');
      var cols = ['#ec4899','#8b5cf6','#6b7280','#f9a8d4','#a78bfa'];
      var ps = [];
      for (var i = 0; i < 80; i++) {
        ps.push({ x: rect.left + Math.random()*rect.width, y: rect.top + Math.random()*rect.height, vx: (Math.random()-.5)*6, vy: (Math.random()-1)*7, r: Math.random()*4+1, a: 1, c: cols[i % cols.length] });
      }
      el.style.opacity = '0';
      var f = 0;
      function draw() {
        ctx.clearRect(0,0,cv.width,cv.height); f++; var alive = false;
        ps.forEach(function(p) { p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.a-=0.024; if(p.a>0){alive=true;ctx.save();ctx.globalAlpha=p.a;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();} });
        if (alive && f < 100) requestAnimationFrame(draw);
        else { cv.remove(); if (callback) callback(); }
      }
      requestAnimationFrame(draw);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LONG PRESS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function addLongPress(el, fn) {
      el.addEventListener('touchstart', function(e) { _lpt = setTimeout(function(){ _ctxJustShown = true; fn(e); }, 480); }, { passive: true });
      el.addEventListener('touchend',   function() { clearTimeout(_lpt); });
      el.addEventListener('touchmove',  function() { clearTimeout(_lpt); });
      el.addEventListener('mousedown',  function(e) { _lpt = setTimeout(function(){ _ctxJustShown = true; fn(e); }, 480); });
      el.addEventListener('mouseup',    function() { clearTimeout(_lpt); });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONTEXT MENU â€” Copy | Pin | Delete
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showCtx(e, msgId, isMine, text) {
      if (_ctx) _ctx.remove();
      var x = e.touches ? e.touches[0].clientX : (e.clientX || 160);
      var y = e.touches ? e.touches[0].clientY : (e.clientY || 300);
      var menu = document.createElement('div');
      _ctx = menu; menu.className = 'ctx-menu';
      // Keep on screen
      var left = Math.min(x, window.innerWidth - 220);
      var top  = Math.min(y + 10, window.innerHeight - 250);
      menu.style.left = left + 'px'; menu.style.top = top + 'px';

      // Emoji reactions row
      var eRow = '<div class="ctx-emoji-row">';
      ['â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ‘','ğŸ”¥','ğŸ™','ğŸ’¯'].forEach(function(em) {
        eRow += '<button class="ctx-emoji-btn" onclick="reactMsg(\'' + msgId + '\',\'' + em + '\')">' + em + '</button>';
      });
      eRow += '</div>';

      var safe = (text || '').replace(/\\/g,'\\\\').replace(/'/g,"\\'").substring(0, 80);
      var isPinned = (pinnedMsgId === msgId);

      menu.innerHTML = eRow +
        ctxBtn('ğŸ“‹', 'Copy',          'copyMsg(\'' + safe + '\')') +
        ctxBtn('ğŸ“Œ', isPinned ? 'Unpin' : 'Pin Message', isPinned ? 'unpinMsg(null)' : 'pinMsg(\'' + msgId + '\',\'' + safe + '\')') +
        (isMine ? ctxBtn('ğŸ—‘ï¸', 'Delete', 'deleteMsg(\'' + msgId + '\')', true) : '');

      document.body.appendChild(menu);
      // Auto-close on next click
      setTimeout(function() {
        function rmCtx(ev) {
          if (_ctxJustShown) { _ctxJustShown = false; return; }
          if (_ctx && !_ctx.contains(ev.target)) { _ctx.remove(); _ctx = null; document.removeEventListener('click', rmCtx); document.removeEventListener('touchend', rmCtx); }
        }
        document.addEventListener('click', rmCtx);
        document.addEventListener('touchend', rmCtx);
      }, 150);
    }

    function ctxBtn(icon, label, action, danger) {
      return '<button class="ctx-item' + (danger ? ' ctx-danger' : '') + '" onclick="' + action + '">' +
        '<span style="font-size:18px">' + icon + '</span>' + label + '</button>';
    }

    function copyMsg(t) {
      if (_ctx) { _ctx.remove(); _ctx = null; }
      navigator.clipboard.writeText(t).then(function() { showToast('Copied!'); });
    }

    function reactMsg(msgId, emoji) {
      if (_ctx) { _ctx.remove(); _ctx = null; }
      db.ref('chats/' + chatId + '/' + msgId + '/reactions/' + currentUser.uid).set(emoji);
      showToast(emoji + ' reaction sent');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PIN MESSAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function pinMsg(msgId, text) {
      if (_ctx) { _ctx.remove(); _ctx = null; }
      pinnedMsgId = msgId;
      db.ref('chat_pins/' + chatId).set({ msgId: msgId, text: text, ts: Date.now() });
      showPinnedBanner(msgId, text);
      showToast('ğŸ“Œ Message pinned!');
    }

    function showPinnedBanner(msgId, text) {
      pinnedMsgId = msgId;
      var b = document.getElementById('pinnedBanner');
      document.getElementById('pinnedText').textContent = text || '(media)';
      b.style.display = 'flex';
      b.classList.remove('slide-down');
      void b.offsetWidth; // force reflow
      b.classList.add('slide-down');
    }

    function scrollToPinned() {
      if (!pinnedMsgId) return;
      var el = document.getElementById('cm_' + pinnedMsgId);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.transition = 'background .3s';
        el.style.background = 'rgba(167,139,250,.2)';
        el.style.borderRadius = '12px';
        setTimeout(function() { el.style.background = ''; }, 1300);
      }
    }

    function unpinMsg(e) {
      if (e && e.stopPropagation) e.stopPropagation();
      if (_ctx) { _ctx.remove(); _ctx = null; }
      pinnedMsgId = null;
      document.getElementById('pinnedBanner').style.display = 'none';
      db.ref('chat_pins/' + chatId).remove();
      showToast('Message unpinned');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DELETE (with dust animation)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function deleteMsg(msgId) {
      if (_ctx) { _ctx.remove(); _ctx = null; }
      var el = document.getElementById('cm_' + msgId);
      if (!el) return;
      dustDelete(el, function() {
        if (el.parentNode) el.remove();
        db.ref('chats/' + chatId + '/' + msgId).remove();
        if (pinnedMsgId === msgId) unpinMsg(null);
      });
    }

    function confirmDeleteAll() { document.getElementById('deleteAllModal').classList.remove('hidden'); }
    function closeDeleteAll()   { document.getElementById('deleteAllModal').classList.add('hidden'); }

    function deleteAllMine() {
      closeDeleteAll();
      showLoading('Deletingâ€¦');
      db.ref('chats/' + chatId).once('value').then(function(snap) {
        var upd = {};
        snap.forEach(function(c) { if (c.val().senderUid === currentUser.uid) upd['chats/' + chatId + '/' + c.key] = null; });
        return db.ref().update(upd);
      }).then(function() {
        hideLoading();
        showToast('Your messages deleted âœ…');
      }).catch(function(err) {
        hideLoading();
        showToast('Error: ' + err.message, 'error');
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEND MESSAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function sendMsg() {
      var inp  = document.getElementById('inp');
      var text = inp.value.trim();
      if (!text && !pendingFile) return;
      inp.value = '';
      onInputChange(); // hide send button
      if (!currentUser) { showToast('Not logged in', 'error'); return; }

      if (pendingFile) {
        var f = pendingFile; pendingFile = null; clearFile();
        showLoading('Uploadingâ€¦');
        uploadFile(f, 'chat').then(function(res) {
          hideLoading();
          db.ref('chats/' + chatId).push({ text: text || 'ğŸ“ Sent a file', fileUrl: res.success ? res.url : null, fileType: f.type, senderUid: currentUser.uid, ts: Date.now() });
        });
      } else {
        db.ref('chats/' + chatId).push({ text: text, senderUid: currentUser.uid, ts: Date.now() });
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FILE ATTACH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function pickFile() {
      var inp = document.createElement('input');
      inp.type = 'file'; inp.accept = 'image/*,application/pdf';
      inp.onchange = function() {
        if (inp.files[0]) {
          pendingFile = inp.files[0];
          document.getElementById('fileStripName').textContent = inp.files[0].name;
          document.getElementById('fileStrip').classList.remove('hidden');
          onInputChange();
        }
      };
      inp.click();
    }

    function clearFile() {
      pendingFile = null;
      document.getElementById('fileStrip').classList.add('hidden');
      onInputChange();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EMOJI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ins(e) { var inp = document.getElementById('inp'); inp.value += e; closeEmoji(); inp.focus(); onInputChange(); }
    function toggleEmoji(e) { if(e) e.stopPropagation(); document.getElementById('emojiPicker').classList.toggle('hidden'); }
    function closeEmoji() { document.getElementById('emojiPicker').classList.add('hidden'); }
    document.addEventListener('click', function(e) {
      var picker = document.getElementById('emojiPicker');
      if (picker && !picker.classList.contains('hidden') && !picker.contains(e.target)) {
        var isEmojiBtn = e.target.closest('[onclick*="toggleEmoji"]') || e.target.closest('button[title="Emoji"]');
        if (!isEmojiBtn) picker.classList.add('hidden');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PROFILE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showProfile() {
      var u = friendData;
      document.getElementById('pmAvatar').textContent = (u.name || friendName)[0].toUpperCase();
      document.getElementById('pmName').textContent   = u.name  || friendName;
      document.getElementById('pmBio').textContent    = u.bio   || 'Physio SUAI Member';
      document.getElementById('pmEmail').textContent  = u.email || '';
      document.getElementById('profileModal').classList.remove('hidden');
    }
    function closeProfile() { document.getElementById('profileModal').classList.add('hidden'); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function timeAgo(ts) {
      var s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60)    return 'just now';
      if (s < 3600)  return Math.floor(s/60) + 'm ago';
      if (s < 86400) return Math.floor(s/3600) + 'h ago';
      return new Date(ts).toLocaleDateString();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH GATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    auth.onAuthStateChanged(function(u) {
      if (u) { currentUser = u; init(); }
      else location.href = '../index.html';
    });
  </script>
</body>
</html>
