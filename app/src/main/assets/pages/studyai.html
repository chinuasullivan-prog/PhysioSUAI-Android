<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study AI â€“ Physio SUAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/hybrid-config.js"></script>
    <style>
        .icon-btn{width:46px;height:46px;border-radius:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .15s,box-shadow .15s;cursor:pointer;border:none;outline:none}
        .icon-btn:active{transform:scale(.92)}
        .btn-back{background:linear-gradient(135deg,#374151,#1f2937);border:1.5px solid #4b5563;color:#e5e7eb}
        .btn-clear{background:linear-gradient(135deg,#374151,#1f2937);border:1.5px solid #4b5563;color:#e5e7eb}
        .btn-attach{background:linear-gradient(135deg,#374151,#1f2937);border:1.5px solid #4b5563;color:#e5e7eb}
        .btn-send{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;box-shadow:0 4px 16px #8b5cf660;border:none}
        .btn-send:hover{box-shadow:0 6px 20px #8b5cf680;transform:translateY(-1px)}
        .msg-input{flex:1;padding:12px 18px;background:#1f2937;border:1.5px solid #374151;border-radius:24px;color:#fff;font-size:15px;outline:none;transition:border .2s}
        .msg-input:focus{border-color:#8b5cf6}
        .msg-input::placeholder{color:#6b7280}
        .typing-dot{width:8px;height:8px;border-radius:50%;background:#8b5cf6;animation:tb 1.4s infinite ease-in-out;display:inline-block;margin:0 2px}
        .typing-dot:nth-child(2){animation-delay:.2s}
        .typing-dot:nth-child(3){animation-delay:.4s}
        @keyframes tb{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-8px)}}
        .ai-bubble b,.ai-bubble strong{color:#e9d5ff}
        .ai-bubble ul{list-style:disc;padding-left:16px;margin:6px 0}
        .ai-bubble li{margin-bottom:3px}
        .msg-enter{animation:msgIn .25s ease}
        @keyframes msgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

<!-- NAV -->
<nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50 px-4 py-3">
    <div class="max-w-4xl mx-auto flex items-center gap-3">
        <button onclick="window.location.href='../home.html'" class="icon-btn btn-back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        </button>
        <h1 class="font-bold text-lg flex-1 text-center">ğŸ¤– Physio AI</h1>
        <button onclick="clearChat()" class="icon-btn btn-clear" title="Clear chat">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
        </button>
    </div>
</nav>

<!-- MESSAGES -->
<div id="messages" class="flex-1 overflow-y-auto px-4 py-4 space-y-4" style="padding-bottom:20px"></div>

<!-- TYPING -->
<div id="typingRow" class="hidden px-4 py-2">
    <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center text-base flex-shrink-0">ğŸ¤–</div>
        <div class="bg-gray-700 rounded-2xl rounded-bl-sm px-4 py-3">
            <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
        </div>
    </div>
</div>

<!-- INPUT BAR - Fixed at bottom -->
<div class="px-4 py-3 bg-gray-800 border-t border-gray-700 flex-shrink-0">
    <div class="max-w-4xl mx-auto flex items-center gap-3">
        <button onclick="pickFile()" class="icon-btn btn-attach" title="Attach">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <div style="flex:1;display:flex;align-items:center;background:#1f2937;border:1.5px solid #374151;border-radius:24px;padding:0 6px 0 18px;transition:border-color .2s" id="aiInputWrap">
            <input id="aiInput" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:15px;padding:12px 6px 12px 0;font-family:inherit" placeholder="Ask about anatomy, exercises, treatmentâ€¦"
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();doSend()}"
                oninput="aiTyping()"
                onfocus="document.getElementById('aiInputWrap').style.borderColor='#8b5cf6'"
                onblur="document.getElementById('aiInputWrap').style.borderColor='#374151'">
            <button id="aiSendBtn" onclick="doSend()" title="Send"
                style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .2s,width .25s;transform:scale(0);opacity:0;overflow:hidden">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>
</div>

<script src="../js/main.js"></script>
<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GEMINI_KEY = 'AIzaSyCjNS_rM5u7ulqFaKKptCw_TfO668huY1U';
var GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + GEMINI_KEY;
var SYSTEM = 'You are Physio AI, a study assistant for physiotherapy students at SUAI Nigeria. Help with anatomy, physiology, exercises, clinical assessment, treatment protocols. Use clear formatting with bullet points. Be concise and encouraging.';

var busy = false;
var msgCount = 0;

// â”€â”€ Send handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function aiTyping() {
    var val = document.getElementById('aiInput').value;
    var btn = document.getElementById('aiSendBtn');
    if (!btn) return;
    if (val.trim().length > 0) {
        btn.style.transform = 'scale(1)';
        btn.style.opacity   = '1';
        btn.style.width     = '38px';
    } else {
        btn.style.transform = 'scale(0)';
        btn.style.opacity   = '0';
    }
}

function doSend() {
    if (busy) return;

    var inp = document.getElementById('aiInput');
    var q = (inp.value || '').trim();
    if (!q) return;

    // Clear input immediately
    inp.value = '';

    // Show user message
    showMsg('user', q);

    // Show typing
    setTyping(true);
    busy = true;

    // Call Gemini
    callGemini(q);
}

function callGemini(question) {
    var body = JSON.stringify({
        contents: [{ role: 'user', parts: [{ text: SYSTEM + '\n\nStudent question: ' + question }] }],
        generationConfig: { maxOutputTokens: 800, temperature: 0.7 }
    });

    fetch(GEMINI_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: body
    })
    .then(function(res) {
        return res.json();
    })
    .then(function(data) {
        setTyping(false);
        busy = false;
        var answer = '';
        try {
            answer = data.candidates[0].content.parts[0].text;
        } catch(e) {
            // API returned error or unexpected format
            var errMsg = (data.error && data.error.message) ? data.error.message : 'No response';
            console.warn('Gemini parse error:', errMsg, data);
            answer = null;
        }
        if (answer) {
            showMsg('ai', answer, 'Gemini');
        } else {
            showMsg('ai', getOfflineAnswer(question), 'Offline Mode');
        }
    })
    .catch(function(err) {
        console.warn('Gemini network error:', err);
        setTyping(false);
        busy = false;
        // Always show a useful response even when API fails
        showMsg('ai', getOfflineAnswer(question), 'Offline Mode');
    });
}

// â”€â”€ Render message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMsg(role, text, provider) {
    var c = document.getElementById('messages');
    if (!c) return;

    var id = 'msg_' + (++msgCount);
    var div = document.createElement('div');
    div.id = id;
    div.className = 'msg-enter';

    // Format text: **bold**, newlines to <br>, bullets
    var fmt = String(text)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\nâ€¢\s/g, '<br>â€¢ ')
        .replace(/\n-\s/g, '<br>â€¢ ')
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');

    if (role === 'user') {
        div.style.cssText = 'display:flex;justify-content:flex-end;margin-bottom:4px';
        div.innerHTML =
            '<div style="max-width:80%">' +
              '<div style="background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:18px 18px 4px 18px;padding:12px 16px;font-size:14px;line-height:1.5;word-break:break-word;color:#fff">' + fmt + '</div>' +
              '<p style="font-size:11px;color:#6b7280;text-align:right;margin-top:3px">You Â· just now</p>' +
            '</div>';
    } else {
        div.style.cssText = 'display:flex;align-items:flex-start;gap:10px;margin-bottom:4px';
        div.innerHTML =
            '<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#ec4899);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸ¤–</div>' +
            '<div style="flex:1;min-width:0">' +
              '<p style="font-size:11px;color:#8b5cf6;font-weight:600;margin-bottom:4px">Physio AI' + (provider ? ' Â· <span style=\"color:#6b7280\">' + provider + '</span>' : '') + '</p>' +
              '<div class="ai-bubble" style="background:#1f2937;border:1px solid #374151;border-radius:4px 18px 18px 18px;padding:12px 16px;font-size:14px;line-height:1.6;word-break:break-word;color:#e5e7eb">' + fmt + '</div>' +
            '</div>';
    }

    c.appendChild(div);
    c.scrollTop = c.scrollHeight;
}

function setTyping(show) {
    var t = document.getElementById('typingRow');
    if (t) {
        t.className = show ? '' : 'hidden';
        if (show) {
            var c = document.getElementById('messages');
            if (c) c.scrollTop = c.scrollHeight + 999;
        }
    }
}

function clearChat() {
    msgCount = 0;
    var c = document.getElementById('messages');
    if (c) c.innerHTML = '';
    showWelcome();
}

function pickFile() {
    var inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'image/*,.pdf';
    inp.onchange = function() {
        if (inp.files[0]) {
            // Show file name in input as context
            document.getElementById('aiInput').value = 'Analyze this file: ' + inp.files[0].name;
            document.getElementById('aiInput').focus();
        }
    };
    inp.click();
}

// â”€â”€ Offline knowledge base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getOfflineAnswer(q) {
    q = q.toLowerCase();
    if (q.includes('muscle')) return '**Muscle Groups in Physiotherapy:**\n\nâ€¢ **Upper limb:** deltoid, biceps, triceps, rotator cuff\nâ€¢ **Lower limb:** quadriceps, hamstrings, glutes, gastrocnemius\nâ€¢ **Core:** transversus abdominis, multifidus, pelvic floor\n\nAssessment uses Manual Muscle Testing (MMT) graded 0â€“5.\n\n*Note: Currently in offline mode â€“ connect to internet for full AI responses.*';
    if (q.includes('spine') || q.includes('back')) return '**Spine Anatomy:**\n\nâ€¢ Cervical: 7 vertebrae (C1â€“C7)\nâ€¢ Thoracic: 12 vertebrae (T1â€“T12)\nâ€¢ Lumbar: 5 vertebrae (L1â€“L5)\nâ€¢ Sacrum + Coccyx\n\nCommon issues: disc herniation, scoliosis, spinal stenosis, spondylolisthesis.\n\n*Offline mode â€“ connect to internet for detailed AI answers.*';
    if (q.includes('joint')) return '**Joint Types:**\n\nâ€¢ **Ball & socket:** hip, shoulder (most mobile)\nâ€¢ **Hinge:** knee, elbow, ankle\nâ€¢ **Pivot:** atlantoaxial joint\nâ€¢ **Saddle:** thumb carpometacarpal joint\nâ€¢ **Plane (gliding):** intercarpal, intertarsal joints\n\nROM is measured with goniometry.\n\n*Offline mode.*';
    if (q.includes('exercise') || q.includes('rehab')) return '**Rehabilitation Exercise Principles (FITT):**\n\nâ€¢ **Frequency:** 3â€“5 times/week\nâ€¢ **Intensity:** 60â€“80% of 1RM for strength\nâ€¢ **Time:** 20â€“60 minutes per session\nâ€¢ **Type:** Strengthening, stretching, balance, proprioception\n\nProgressions follow the SAID principle (Specific Adaptation to Imposed Demands).\n\n*Offline mode.*';
    if (q.includes('pain')) return '**Pain Assessment Tools:**\n\nâ€¢ VAS â€“ Visual Analogue Scale (0â€“10)\nâ€¢ NRS â€“ Numeric Rating Scale\nâ€¢ McGill Pain Questionnaire\nâ€¢ Brief Pain Inventory\n\nPain types: Nociceptive, Neuropathic, Nociplastic.\nAlways assess: onset, location, quality, radiation, severity, aggravating/relieving factors.\n\n*Offline mode.*';
    if (q.includes('soap') || q.includes('assess')) return '**SOAP Assessment Framework:**\n\nâ€¢ **S**ubjective: Chief complaint, history, pain levels\nâ€¢ **O**bjective: Observation, palpation, ROM, strength, special tests\nâ€¢ **A**ssessment: Clinical diagnosis, problem list\nâ€¢ **P**lan: Goals, treatment interventions, frequency\n\nSpecial tests vary by joint and suspected pathology.\n\n*Offline mode.*';
    if (q.includes('anatomy')) return '**Key Anatomy Areas for Physiotherapy:**\n\nâ€¢ Musculoskeletal system (bones, muscles, joints, ligaments, tendons)\nâ€¢ Peripheral nervous system (nerve roots, dermatomes, myotomes)\nâ€¢ Cardiovascular system (heart, major vessels)\nâ€¢ Respiratory system (lungs, diaphragm mechanics)\nâ€¢ Gait biomechanics and movement analysis\n\n*Offline mode â€“ connect to internet for full AI-powered answers.*';
    return '**Physio AI is in Offline Mode** ğŸ”Œ\n\nCould not connect to Gemini AI right now. I can still help with these topics:\n\nâ€¢ Type **"muscle"** â€“ muscle anatomy & testing\nâ€¢ Type **"spine"** or **"back"** â€“ spinal anatomy\nâ€¢ Type **"joint"** â€“ joint types & ROM\nâ€¢ Type **"exercise"** â€“ rehab principles\nâ€¢ Type **"pain"** â€“ pain assessment\nâ€¢ Type **"SOAP"** â€“ assessment framework\nâ€¢ Type **"anatomy"** â€“ key anatomy overview\n\nOr connect to the internet for full AI-powered answers!';
}

// â”€â”€ Welcome message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWelcome() {
    showMsg('ai',
        'ğŸ‘‹ Hello! I\'m **Physio AI**, powered by Google Gemini.\n\n' +
        'Ask me anything about:\n\n' +
        'â€¢ ğŸ§¬ Anatomy & Physiology\n' +
        'â€¢ ğŸ’ª Therapeutic Exercises & Rehab\n' +
        'â€¢ ğŸ“‹ Clinical Assessment (SOAP, MMT, ROM)\n' +
        'â€¢ ğŸ©º Treatment Protocols\n' +
        'â€¢ ğŸ“š Exam Preparation & Study Tips\n\n' +
        'Type your question below and press Send! â¡ï¸',
        'Gemini'
    );

    // Quick-prompt chips
    setTimeout(function() {
        var c = document.getElementById('messages');
        if (!c) return;
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px;padding:4px 0';
        var chips = ['Rotator cuff injury', 'SOAP assessment', 'Knee rehab', 'Spine anatomy', 'Pain assessment', 'Core strengthening'];
        chips.forEach(function(chip) {
            var btn = document.createElement('button');
            btn.textContent = chip;
            btn.style.cssText = 'background:#1f2937;border:1.5px solid #374151;color:#d1d5db;padding:8px 14px;border-radius:20px;font-size:13px;cursor:pointer;white-space:nowrap;transition:all .2s';
            btn.onmouseover = function(){ this.style.borderColor='#8b5cf6'; this.style.color='#e9d5ff'; };
            btn.onmouseout  = function(){ this.style.borderColor='#374151'; this.style.color='#d1d5db'; };
            btn.onclick = function() {
                document.getElementById('aiInput').value = chip;
                row.remove();
                doSend();
            };
            row.appendChild(btn);
        });
        c.appendChild(row);
        c.scrollTop = c.scrollHeight;
    }, 200);
}

showWelcome();
</script>
</body>
</html>
